#Output Data Compilation

### Clear any existing data or functions.
rm(list=ls())
library("dplyr", lib.loc="~/R/win-library/3.5")

###Total Storage Compilation#--------------------------------------------------------------------------------#

setwd("~/GitHub/WeberBasinVulnerability/WeberBasinVulnerability/2 - RiverWare Modeling/Scenario")
library(readr)

#Plots
####-----------------------------Line Plots--------------------------------------------------

  ##################################Input data########################################################
TraceNumber <- 6
TraceNumber1 <-6
TraceNumber2 <-3
Tot_TraceNum <- TraceNumber*TraceNumber1*TraceNumber2


Tot_Stor <- read.csv("Trace1,Trace1,Trace1/Total Storage_NO EVAP.csv")
Tot_Inflow <-read.csv("Trace1,Trace1,Trace1/Total Inflows.csv")
Tot_Shortages <-read.csv("Trace1,Trace1,Trace1/Total Shortages.csv")

#Create TraceFolder Naming lookup for Values with No Evap.

### Total Storage
i=1
 for(TTTNum in 1:TraceNumber){
   for(TTNum in 1:TraceNumber1){
     for(TNum in 1:TraceNumber2){
       TraceDirectory <- paste0(",Trace",TNum)
       TraceDirectory <-paste0 (TraceDirectory,"/Total Storage_NO EVAP.csv")
       TraceNum1<- paste0(",Trace",TTNum)
       TraceDirectory <- paste0(TraceNum1,TraceDirectory)
       TraceNum2 <- paste0("Trace",TTTNum)
       TraceDirectory <- paste0(TraceNum2,TraceDirectory)

       Location <- TraceDirectory
       Temp_Storage <- read_csv(Location)
       Tot_Stor[,i] <- Temp_Storage[,5]

       colnames(Tot_Stor)[i] <-  TraceDirectory
 i=i+1
     }
   }
 }
 Tot_Stor <- data.frame(Tot_Stor)

 #add Date column
 Date <- seq.Date(as.Date("0000/11/30"),by ="month",length=359)
 Tot_Stor$Date <- Date
 Months <- rep(c(1:12),31)
 Months<- Months[(11:369)]
 Tot_Stor$Month <- data.frame(Months)
 #Create Years
 Years <- c(0:372)
 i=1
 j=1
 while (j<=31) {
   Years[(i:(i+11))] <- rep((j-1),12)
   i=i+12
   j=j+1
 }
 Years<- Years[(11:369)]
 Tot_Stor$Year <- data.frame(Years)


 #transpose
 Tot_Stor <- t(Tot_Stor)

 colnames(Tot_Stor) <-  Tot_Stor[109,]

#View(Tot_Stor)


  ### Total Inflows
i=1
      for(TTTNum in 1:TraceNumber){
        for(TTNum in 1:TraceNumber1){
          for(TNum in 1:TraceNumber2){
            TraceDirectory <- paste0(",Trace",TNum)
            TraceDirectory <-paste0 (TraceDirectory,"/Total Inflows.csv")
            TraceNum1<- paste0(",Trace",TTNum)
            TraceDirectory <- paste0(TraceNum1,TraceDirectory)
            TraceNum2 <- paste0("Trace",TTTNum)
            TraceDirectory <- paste0(TraceNum2,TraceDirectory)

      Location <- TraceDirectory
      Temp_Storage <- read_csv(Location)
      Tot_Inflow[,i] <- Temp_Storage[,5]

      colnames(Tot_Inflow)[i] <-  TraceDirectory
      i=i+1
    }
  }
}
   Tot_Inflow <- data.frame(Tot_Inflow)
   #add Date column
   Tot_Inflow$Date <-Date
   Tot_Inflow$Month <- data.frame(Months)
   Tot_Inflow$Year <- data.frame(Years)
   #transpose
   Tot_Inflow <- t(Tot_Inflow)
  # column names
   colnames(Tot_Inflow) <-Date
#View(Tot_Inflow)

### Total Shortages
   i=1
   for(TTTNum in 1:TraceNumber){
     for(TTNum in 1:TraceNumber1){
       for(TNum in 1:TraceNumber2){
         TraceDirectory <- paste0(",Trace",TNum)
         TraceDirectory <-paste0 (TraceDirectory,"/Total Shortages.csv")
         TraceNum1<- paste0(",Trace",TTNum)
         TraceDirectory <- paste0(TraceNum1,TraceDirectory)
         TraceNum2 <- paste0("Trace",TTTNum)
         TraceDirectory <- paste0(TraceNum2,TraceDirectory)
      Location <- TraceDirectory
      Temp_Storage <- read_csv(Location)
      Tot_Shortages[,i] <- Temp_Storage[,5]
      colnames(Tot_Shortages)[i] <-  TraceDirectory
      i=i+1
    }
     }
       }
  Tot_Shortages <- data.frame(Tot_Shortages)

  #add Date column
  Tot_Shortages$Date <- Date
  Tot_Shortages$Month <- data.frame(Months)
  Tot_Shortages$Year <- data.frame(Years)
  #transpose
  Tot_Shortages <- t(Tot_Shortages)
  # column names
  colnames(Tot_Shortages) <-  seq.Date(as.Date("0000/11/30"),by ="month",length=359)
  #View(Tot_Shortages)

##Total Sedimentation Changes on Reservoir
#Base_Sed <- rep(0,359)
#Mid_Sed <- rep(10,359)
#High_Sed<- rep(30,359) #% change max to reservior volume

#Tot_Sed_Temp <- merge(Base_Sed,Mid_Sed)
#Tot_Sed <- merge(Tot_Sed_Temp,Mid_Sed)
#Tot_Sed <- data.frame(Tot_Sed)

#RowNames

#rownames(Tot_Sed)<-seq.Date(as.Date("0000/11/30"),by ="month",length=359)

#Tot_Sed<- t(Tot_Sed)
#View(Tot_Sedimentation)


### Merge ### AllData Dataframe

AllDataDF <- rbind(Tot_Inflow,Tot_Stor,Tot_Shortages)
AllDataDF <- data.frame(AllDataDF)
c(Date)
colnames(AllDataDF) <- c(Date)







#############################################################################################
#June 1st Total Levels of Storage, Shortages, Inflows and Demands
#############################################################################################

### June1 Storage ### By Water Year November to October
  Tot_Stor_June1 <-1:30
  Tot_Stor_June1 <- data.frame(Tot_Stor_June1)

  k=1
  while (k<=Tot_TraceNum+1) {
    i=1
    j=8
    while (i<=30) {
      Tot_Stor_June1[i,k] <- (na.omit(Tot_Stor[j,k]))
      i=i+1
      j=j+12
    }
    k=k+1
  }
  #View(Tot_Stor_June1)

  #rename columns
  i=1
  for(TTTNum in 1:TraceNumber){
    for(TTNum in 1:TraceNumber1){
      for(TNum in 1:TraceNumber2){
        TraceDirectory <- paste0(",Trace",TNum)
        TraceNum1<- paste0(",Trace",TTNum)
        TraceDirectory <- paste0(TraceNum1,TraceDirectory)
        TraceNum2 <- paste0("Trace",TTTNum)
        TraceDirectory <- paste0(TraceNum2,TraceDirectory)

        colnames(Tot_Stor_June1)[i] <-  TraceDirectory
        i=i+1
      }
    }
  }
    #View(Tot_Stor_June1)

  ####-----------------------------------June1 SHORTAGES -----------------------------------------------

  ## Average June1 Shortages
  Tot_Shortage_June1 <-1:30
  Tot_Shortage_June1 <- data.frame(Tot_Shortage_June1)

  k=1
  while (k<=36) {
    i=1
    j=8
    while (i<=30) {
      Tot_Shortage_June1[i,k] <- na.omit(Tot_Shortages[j,k])
      i=i+1
      j=j+12
    }
    k=k+1
  }

  #rename columns
  i=1
  for(TTTNum in 1:TraceNumber){
    for(TTNum in 1:TraceNumber1){
      for(TNum in 1:TraceNumber2){
        TraceDirectory <- paste0(",Trace",TNum)
        TraceNum1<- paste0(",Trace",TTNum)
        TraceDirectory <- paste0(TraceNum1,TraceDirectory)
        TraceNum2 <- paste0("Trace",TTTNum)
        TraceDirectory <- paste0(TraceNum2,TraceDirectory)

        colnames(Tot_Shortages)[i] <-  TraceDirectory
        i=i+1
      }
    }
  }
  #View(Tot_Shortage_June1)

####-----------------------------------April1 INFLOWS -----------------------------------------------  # Redo in Outputs from RiverWare

  ## Average June1 INFLOWS ###
  Tot_Inflow_June1 <-1:30
  Tot_Inflow_June1 <- data.frame(Tot_Inflow_June1)

  k=1
  while (k<=Tot_TraceNum) {
    i=1
    j=5
    while (i<=30) {
      Tot_Inflow_June1[i,k] <- na.omit(Tot_Inflow[j,k])
      i=i+1
      j=j+12
    }
    k=k+1
  }

  #rename columns
  i=1
  for(TTTNum in 1:TraceNumber){
    for(TTNum in 1:TraceNumber1){
      for(TNum in 1:TraceNumber2){
        TraceDirectory <- paste0(",Trace",TNum)
        TraceNum1<- paste0(",Trace",TTNum)
        TraceDirectory <- paste0(TraceNum1,TraceDirectory)
        TraceNum2 <- paste0("Trace",TTTNum)
        TraceDirectory <- paste0(TraceNum2,TraceDirectory)

        colnames(Tot_Inflow_June1)[i] <-  TraceDirectory
        i=i+1
      }
    }
  }

  #########-----------------------June1 Demands----------------------------------------------------------
  setwd("~/GitHub/WeberBasinVulnerability/WeberBasinVulnerability/3 - Post Processing")

  library(readr)
  SumMIandAG <- read_csv("SumMIandAG.csv")
  #View(SumMIandAG)

  SumMIandAG <- data.frame(SumMIandAG$SummedMIandAG)
  Tot_Demand_June1 <- c(rep(SumMIandAG$SumMIandAG.SummedMIandAG,6))
  Tot_Demand_June1 <- data.frame(Tot_Demand_June1)

  #View(Tot_Demand_June1)
  Tot_Demand_June1_Step1 <- data.frame(rep(Tot_Demand_June1,30))

  #Transpose
  Stacked_Demand_June1step1 <- data.frame(t(Tot_Demand_June1_Step1))
  Stacked_Demand_June1<- stack(Stacked_Demand_June1step1)
  #View(Stacked_Demand_June1)

  #Rename columns
  names(Stacked_Demand_June1)[2] <- paste("Month")
  names(Stacked_Demand_June1)[1] <- paste("Demand")

  # Change Date column
  Stacked_Demand_June1$Year <- rep(c(1:30))

  #Create ID number Column
  Stacked_Demand_June1$ID <- c(1:1080)


  ###########################################################################################################
  ############################Compile all data into one data.frame###########################################
  ###########################################################################################################
  #Storage Data in one Column
  Stacked_Stor_June1 <- stack(Tot_Stor_June1)
  Stacked_Inflow_June1 <- stack(Tot_Inflow_June1)
  Stacked_Shortage_June1 <- stack(Tot_Shortage_June1)

  #Rename Columns
  names(Stacked_Stor_June1)[2] <- paste("Traces")
  names(Stacked_Stor_June1)[1] <- paste("Storage")
  names(Stacked_Inflow_June1)[2] <- paste("Traces")
  names(Stacked_Inflow_June1)[1] <- paste("Inflows")
  names(Stacked_Shortage_June1)[2] <- paste("Traces")
  names(Stacked_Shortage_June1)[1] <- paste("Shortages")


  #Create ID number Column
  Stacked_Inflow_June1$ID <-c(1:1080)
  Stacked_Stor_June1$ID <-c(1:1080)
  Stacked_Shortage_June1$ID<-c(1:1080)

  #Merge Data frames
  tempfile <- merge(Stacked_Demand_June1,Stacked_Inflow_June1,by ="ID")
  tempfile <- merge(tempfile,Stacked_Shortage_June1,by = "ID")

  #View(tempfile)
  AllDataDF <- merge(tempfile,Stacked_Stor_June1,by ="ID")

  #Get rid of nonessential columns
  J1Data <- data.frame(AllDataDF$Demand,AllDataDF$Inflows,AllDataDF$Storage,AllDataDF$Shortages,AllDataDF$Year)
  #View(Data)
  names(J1Data)[1] <- paste("Demand")
  names(J1Data)[2] <- paste("Inflows")
  names(J1Data)[3] <- paste("Storage")
  names(J1Data)[4] <- paste("Shortages")
  J1Data$Sedimentation<- Tot_Sedimentation$`Total Sedimentation`

#View(Data)

##################################################################################################
###PLOTS###
##################################################################################################
  library(plotly)

  if (!require("processx")) install.packages("processx")
  setwd("~/GitHub/WeberBasinVulnerability/WeberBasinVulnerability/3 - Post Processing/Output")


###################### Contour Plots ############################################################

#Shortage
  p <- plot_ly(
    x = J1Data$Demand,
    y = J1Data$Inflows,
    z = J1Data$Shortages, nrow = 9720, ncol = 9720,type = "contour")%>%
    layout(title = "Shortages by Color",
           xaxis = list(title ="Demand"),
           yaxis = list(title = "Inflows"))
  p

#Storage
  p <- plot_ly(
    x = J1Data$Demand,
    y = J1Data$Inflows,
    z = J1Data$Storage, nrow = 9720, ncol = 9720, type = "contour")%>%
    layout(title = "Storage by Color",
           xaxis = list(title ="Demand"),
           yaxis = list(title = "Inflows"))
      p

# Sedimentation   -- Issues with only plotting the 30% level for the sedimentation
  p <- plot_ly(
    x = J1Data$Demand,
    y = J1Data$Inflows,
    z = J1Data$Sedimentation, type = "contour")%>%
    layout(title = "Sedimentation by Color",
           xaxis = list(title="Demand"),
           yaxis = list(title="Inflows"))
  p

  p <- plot_ly(
    x = J1Data$Demand,
    y = J1Data$Sedimentation,
    z = J1Data$Inflows, type = "contour")%>%
    layout(title = "Sedimentation by Color",
           xaxis = list(title="Demand"),
           yaxis = list(title="Sedimentation"))
  p


############ Storage Contours based on Moderate Severe and Extreme Storage Drought Levels  #############################
   #Storage
  p <- plot_ly(
    x = J1Data$Demand,
    y = J1Data$Inflows,
    z = J1Data$Storage, type = "contour",
    colors = c("red","orange","yellow","white"),
    #contours = list(coloring = 'heatmap'),
    autocontour = F,contours = list(
      start = 280000,
      end = 380000,
      size = 50000
    ))%>%
    layout(title = "Storage by Color",
           xaxis = list(title ="Demand"),
           yaxis = list(title = "Inflows"))
  p

#Set all data above 380,000 acreft of storage to NA in order to show other levels more effectively

  NData <- data.frame(J1Data[1,])
  i=1
  j=1

  while (i<=9720) {
    ifelse(J1Data[i,3] >= 380000, j==j-1 ,NData[j,] <- J1Data[i,])
    i=i+1
    j=j+1
  }
  NData[1,3] <- 350000

  #Storage

  p <- plot_ly(
    x = NData$Demand,
    y = NData$Inflows,
    z = NData$Storage, type = "contour",
    colors = c("red","orange","yellow","white"),
    #contours = list(coloring = 'heatmap',colors = c("red","orange","yellow","white")),
    autocontour = F,contours = list(
      start = 280000,
      end = 380000,
      size = 50000
    ))%>%
    layout(title = "Storage by Color",
           xaxis = list(title ="Demand"),
           yaxis = list(title = "Inflows"))
  p

### Get rid of 0 Values in Shortages

newData <- data.frame(J1Data[1,])
i=1
j=1

while (i<=9720) {
  ifelse(J1Data[i,4] == 0, j==j-1 ,newData[j,] <- J1Data[i,])
  i=i+1
  j=j+1
}
newData[1,4] <- rep('NA')
#View(newData)

#######################Plot New Data with no Zeros #####################################
#Shortage
p <- plot_ly(
  x = newData$Demand,
  y = newData$Inflows,
  z = newData$Shortages, type = "contour")%>%
  layout(title = "Shortages by Color",
         xaxis = list(title ="Demand"),
         yaxis = list(title = "Inflows"))
p

#Storage  --- Use Reliability
p <- plot_ly(
  x = newData$Demand,
  y = newData$Inflows,
  z = newData$Storage, type = "contour")%>%
  layout(title = "Storage by Color",
         xaxis = list(title ="Demand"),
         yaxis = list(title = "Inflows"))
p


p <- plot_ly(
  x = newData$Demand,
  y = newData$Inflows,
  z = newData$Storage, type = "contour",
  colors = c("red","orange","yellow","white"),
  #contours = list(coloring = 'heatmap',colors = c("red","orange","yellow","white")),
  autocontour = F,contours = list(
    start = 280000,
    end = 380000,
    size = 50000
  ))%>%
  layout(title = "Storage by Color",
         xaxis = list(title ="Demand"),
         yaxis = list(title = "Inflows"))
p

# Sedimentation & Shortage
p <- plot_ly(
  x = newData$Sedimentation,
  y = newData$Inflows,
  z = newData$Shortages, type = "contour")%>%
  layout(title = "Sedimentation by Color",
         xaxis = list(title="Sedimentation"),
         yaxis = list(title="Inflows"))
p


########## Plot Scatter Plots ###########
### Individual plots
#X = Demand, Y= Inflows
p <- plot_ly(newData,x =newData$Demand,y=newData$Inflows ,color = newData$Storage,colors = blues9)%>%
  layout(title = "Storage by Color",
         xaxis = list(title ="Demand"),
         yaxis = list(title = "Inflows"))
p

#X = Demand, Y= Inflows Z = Shortages
p <- plot_ly(newData,x =newData$Demand,y=newData$Inflows ,color = newData$Shortages,colors = blues9)%>%   #How to ignore 0 values
  layout(title = "Shortages by Color",
         xaxis = list(title ="Demand"),
         yaxis = list(title = "Inflows"))
p

#X = Shortage, Y= Storage Z= Demands
p <- plot_ly(newData,x =newData$Shortage,y=newData$Storage ,color = newData$Demand) %>%
  layout(title = "Demand by Color",
         xaxis = list(title ="Shortage (Acre-Feet)"),
         yaxis = list(title = "Storage (Acre-Feet)"))                        # look at removing 0 values of Shortages in plots
p

#X = Shortage, Y= Storage Z= Inflows
p <- plot_ly(newData,x =newData$Shortage,y=newData$Storage ,color = newData$Inflows)%>%
  layout(title = "Inflows by Color",
         xaxis = list(title ="Shortage (Acre-Feet)"),
         yaxis = list(title = "Storage (Acre-Feet)"))
p

                                                  ############ End of June 1 code##########



#############################################################################################
#Annual Totals
#############################################################################################

  ## Annual Storage ### By Water Year November to October
  Tot_Stor_Annual <-1:30
  Tot_Stor_Annual <- data.frame(Tot_Stor_Annual)

  k=1
  while (k<=36) {
    i=1
    j=12
    while (i<=30) {
      Tot_Stor_Annual[i,k] <- sum(na.omit(Tot_Stor[(j-11):j,k]))
      i=i+1
      j=j+12
    }
    k=k+1
  }

  #View(Tot_Stor_Annual)

  #rename columns
  i=1
  for(TTTNum in 1:TraceNumber){
    for(TTNum in 1:TraceNumber1){
      for(TNum in 1:TraceNumber2){
        TraceDirectory <- paste0(",Trace",TNum)
        TraceNum1<- paste0(",Trace",TTNum)
        TraceDirectory <- paste0(TraceNum1,TraceDirectory)
        TraceNum2 <- paste0("Trace",TTTNum)
        TraceDirectory <- paste0(TraceNum2,TraceDirectory)

        colnames(Tot_Stor_Annual)[i] <-  TraceDirectory
        i=i+1
      }
    }
  }
  #View(Tot_Stor_Annual)
  ####-----------------------------------ANNUAL SHORTAGES -----------------------------------------------

  ## Average Annual Shortages
  Tot_Shortage_Annual <-1:30
  Tot_Shortage_Annual <- data.frame(Tot_Shortage_Annual)

  k=1
  while (k<=Tot_TraceNum) {
    i=1
    j=12
    while (i<=30) {
      Tot_Shortage_Annual[i,k] <- sum(na.omit(Tot_Shortages[(j-11):j,k]))
      i=i+1
      j=j+12
    }
    k=k+1
  }

  #View(Tot_Shortage_Annual)

  #rename columns
  i=1
  for(TTTNum in 1:TraceNumber){
    for(TTNum in 1:TraceNumber1){
      for(TNum in 1:TraceNumber2){
        TraceDirectory <- paste0(",Trace",TNum)
        TraceNum1<- paste0(",Trace",TTNum)
        TraceDirectory <- paste0(TraceNum1,TraceDirectory)
        TraceNum2 <- paste0("Trace",TTTNum)
        TraceDirectory <- paste0(TraceNum2,TraceDirectory)

        colnames(Tot_Shortage_Annual)[i] <-  TraceDirectory
        i=i+1
      }
    }
  }
  #View(Tot_Shortage_Annual)

   ####-----------------------------------ANNUAL INFLOWS -----------------------------------------------

  ## Average Annual INFLOWS ### By Water Year November to October
  Tot_Inflow_Annual <-1:30
  Tot_Inflow_Annual <- data.frame(Tot_Inflow_Annual)

  k=1
  while (k<=Tot_TraceNum) {
    i=1
    j=12
    while (i<=30) {
      Tot_Inflow_Annual[i,k] <- sum(na.omit(Tot_Inflow[(j-11):j,k]))
      i=i+1
      j=j+12
    }
    k=k+1
  }

  #View(Tot_Inflow_Annual)

  #rename columns
  i=1
  for(TTTNum in 1:TraceNumber){
    for(TTNum in 1:TraceNumber1){
      for(TNum in 1:TraceNumber2){
        TraceDirectory <- paste0(",Trace",TNum)
        TraceNum1<- paste0(",Trace",TTNum)
        TraceDirectory <- paste0(TraceNum1,TraceDirectory)
        TraceNum2 <- paste0("Trace",TTTNum)
        TraceDirectory <- paste0(TraceNum2,TraceDirectory)

        colnames(Tot_Inflow_Annual)[i] <-  TraceDirectory
        i=i+1
      }
    }
  }

  #########-----------------------Annual Demands----------------------------------------------------------

  setwd("~/GitHub/WeberBasinVulnerability/WeberBasinVulnerability/3 - Post Processing")

  library(readr)
  SumMIandAG <- read_csv("SumMIandAG.csv")
  #View(SumMIandAG)

  SumMIandAG <- data.frame(SumMIandAG$SummedMIandAG)
  Tot_Demand_Annual <- c(rep(SumMIandAG$SumMIandAG.SummedMIandAG,6))
  Tot_Demand_Annual <- data.frame(Tot_Demand_Annual)

  #View(Tot_Demand_Annual)

  Tot_Demand_Annual_Step1 <- data.frame(rep(Tot_Demand_Annual,30))

  #Transpose
  Stacked_Demand_Annualstep1 <- data.frame(t(Tot_Demand_Annual_Step1))

  Stacked_Demand_Annual<- stack(Stacked_Demand_Annualstep1)
  #View(Stacked_Demand_Annual)

  #Rename columns
  names(Stacked_Demand_Annual)[2] <- paste("Year")
  names(Stacked_Demand_Annual)[1] <- paste("Demand")

  # Change Date column
  Stacked_Demand_Annual$Year <- rep(c(1:30))

  #Create ID number Column
  Stacked_Demand_Annual$ID <- c(1:1080)

###########################################################################################################
############################Compile all data into one data.frame###########################################
###########################################################################################################
#Storage Data in one Column

Stacked_Stor_Annual <- stack(Tot_Stor_Annual)
Stacked_Inflow_Annual <- stack(Tot_Inflow_Annual)
Stacked_Shortage_Annual <- stack(Tot_Shortage_Annual)
#Rename Columns
names(Stacked_Stor_Annual)[2] <- paste("Traces")
names(Stacked_Stor_Annual)[1] <- paste("Storage")
names(Stacked_Inflow_Annual)[2] <- paste("Traces")
names(Stacked_Inflow_Annual)[1] <- paste("Inflows")
names(Stacked_Shortage_Annual)[2] <- paste("Traces")
names(Stacked_Shortage_Annual)[1] <- paste("Shortages")


#Create ID number Column
Stacked_Inflow_Annual$ID <-c(1:1080)
Stacked_Stor_Annual$ID <-c(1:1080)
Stacked_Shortage_Annual$ID<-c(1:1080)

#Merge Data frames
#merge factors

tempfile <- merge(Stacked_Demand_Annual,Stacked_Inflow_Annual,by ="ID")
tempfile <- merge(tempfile,Stacked_Shortage_Annual,by = "ID")

#View(tempfile)
AllDataDF <- merge(tempfile,Stacked_Stor_Annual,by ="ID")

#Get rid of nonessential columns
AllAvgData <- data.frame(AllDataDF$Demand,AllDataDF$Inflows,AllDataDF$Storage,AllDataDF$Shortages,AllDataDF$Year)
#View(Data)
names(AllAvgData)[1] <- paste("Demand")
names(AllAvgData)[2] <- paste("Inflows")
names(AllAvgData)[3] <- paste("Storage")
names(AllAvgData)[4] <- paste("Shortages")


##################################################################################################
##PLOTS
##################################################################################################
library(plotly)

### Plot AllData Dataframe ##########
p <- plot_ly(AllAvgData,x =AllAvgData$Demand,y=AllAvgData$Inflows,color = AllAvgData$Storage)
for(trace in colnames(Data)){
  p <- p %>% plotly::add_trace(y = as.formula(paste0("~`",trace,"`")),name = trace)
}

p

p <- plot_ly(AllAvgData,x =AllAvgData$Inflows,y=AllAvgData$Demand,color = AllAvgData$Storage)
for(trace in colnames(AllAvgData)){
  p <- p %>% plotly::add_trace(y = as.formula(paste0("~`",trace,"`")),name = trace)
}
p

p <- plot_ly(AllAvgData,x =AllAvgData$Inflows,color = AllAvgData$Storage) %>%
  layout(title = "Title",
         xaxis = list(title ="Inflows"),
         yaxis = list(title = "Demand (Acre-Feet)          Storage (Acre-Feet)"))
p


p <- plot_ly(AllAvgData,x =AllAvgData$Demand,color = AllAvgData$Storage)
for(trace in colnames(AllAvgData)){
  p <- p %>% plotly::add_trace(y = as.formula(paste0("~`",trace,"`")),name = trace)
}
p

      #################### Individual plots #####################################

#X = Demand, Y= Inflows
p <- plot_ly(AllAvgData,x =AllAvgData$Demand,y=AllAvgData$Inflows ,color = AllAvgData$Storage)%>%
  layout(title = "TITLE",
         xaxis = list(title ="Demand"),
         yaxis = list(title = "Inflows"))
p

#X = Demand, Y= Inflows Z = Shortages
p <- plot_ly(AllAvgData,x =AllAvgData$Demand,y=AllAvgData$Inflows ,color = AllAvgData$Shortages)%>%   #How to ignore 0 values
  layout(title = "Demand Factor to Inflow Factor",
         xaxis = list(title ="Demand"),
         yaxis = list(title = "Inflows"))
p

#X = Shortage, Y= Storage Z= Demands
p <- plot_ly(AllAvgData,x =AllAvgData$Shortage,y=AllAvgData$Storage ,color = AllAvgData$Demand) %>%
  layout(title = "Title",
         xaxis = list(title ="Shortage (Acre-Feet)"),
         yaxis = list(title = "Storage (Acre-Feet)"))                        # look at removing 0 values of Shortages in plots
p

#X = Shortage, Y= Storage Z= Inflows
p <- plot_ly(AllAvgData,x =AllAvgData$Shortage,y=AllAvgData$Storage ,color = AllAvgData$Inflows)%>%
  layout(title = "Title",
         xaxis = list(title ="Shortage (Acre-Feet)"),
         yaxis = list(title = "Storage (Acre-Feet)"))
p


#######plot storage data##---------------------------------------------------------------------------------

#Line plots
  #Loop                   #Get rid of Alpha line??
  #different Colors
  library(plotly)

  p<- plot_ly(Tot_Stor, x = Tot_Stor$Date, name = 'Base', type = 'scatter', mode = 'lines',
              line = list(color = colors(distinct = F), width = 2)) %>%
    layout(title = "Monthly Storage",
      xaxis = list(title ="Time"),
      yaxis = list(title = "Storage (Acre-Feet)"))

  for(trace in colnames(Tot_Stor)){
    p <- p %>% plotly::add_trace(y = as.formula(paste0("~`",trace,"`")),name = trace)
  }
  p

## Average Annual Storage ### By Water Year November to October
  Tot_Stor_Avg_Annual <-1:30
  Tot_Stor_Avg_Annual <- data.frame(Tot_Stor_Avg_Annual)

  k=1
  while (k<=36) {
    i=1
    j=12
    while (i<=30) {
      Tot_Stor_Avg_Annual[i,k] <- mean(na.omit(Tot_Stor[(j-11):j,k]))
      i=i+1
      j=j+12
    }
    k=k+1
  }

#View(Tot_Stor_Avg_Annual)

#rename columns
i=1
TTNum <- 1
TNum <- 1
while (i<=Tot_TraceNum) {

  TraceNum1 <- paste0("Trace",TNum)
  TraceNum2<- paste0(",Trace",TTNum)
  TraceDirectory <- paste0(TraceNum1,TraceNum2)

  colnames(Tot_Stor_Avg_Annual)[i] <-  TraceDirectory

  i=i+1
  if(TTNum > (TraceNumber-1)){
    TNum = TNum +1
  } else {
    TNum = TNum
  }

  if(TTNum > (TraceNumber1-1)){
    TTNum = 1
  } else {
    TTNum = TTNum + 1
  }
}

#add Date column
Tot_Stor_Avg_Annual$Year <- seq.Date(as.Date("0000/11/30"),by ="year",length=30)

#Multiline plot Average Annual Storage

#Line plot
#Loop                   #Get rid of Base line??
#different Colors
library(plotly)

p<- plot_ly(Tot_Stor_Avg_Annual, x = Tot_Stor_Avg_Annual$Year, name = 'Base', type = 'scatter', mode = 'lines',
            line = list(color = colors(distinct = F), width = 2)) %>%
  layout(title = "Average Annual Storage",
    xaxis = list(title ="Time"),
    yaxis = list(title = "Storage (Acre-Feet)"))

for(trace in colnames(Tot_Stor_Avg_Annual)){
  p <- p %>% plotly::add_trace(y = as.formula(paste0("~`",trace,"`")),name = trace)
}
p

    #Parallel plots
  df <- Tot_Stor

  Pp <-df %>%
    plot_ly(type = 'parcoords', x=
            dimensions = list(
              list(range =c(1000,5000)),
              label = 'Storage', values = Storage_Combined
            )
    )


#################### Reliability  Metric for Storage ########################
  #  -- Metrics based on WBWCD - Drought Contigency Plan Drought Levels --  #
        # See Table 3-2 : Hot/Dry Projected Drought for Drought Levels
            # Moderate Total Basin Storage Drought Level 340K to 380K -- Yellow  ("Less than 380K")
            # Severe Total Basin Storage Drought Level 280K to 340K -- Orange    ("Less than 340K")
            # Extreme Total Basin Storage Drought Level less than 280K -- Red    ("Less than 280K")
  ModerateLevel<- 380000
  SevereLevel <- 340000
  ExtremeLevel<-280000

Storage_Metrics <- data.frame(Tot_Stor)
Storage_Rel_Metrics_Moderate <- data.frame(Tot_Stor)
Storage_Rel_Metrics_Severe <- data.frame(Tot_Stor)
Storage_Rel_Metrics_Extreme <- data.frame(Tot_Stor)
#View(Stor_Metrics)

#Moderate
i=1
j=1
while (j<=108) {
  while (i<=359) {
  Storage_Rel_Metrics_Moderate[i,j] <- ifelse(Tot_Stor[i,j]>ModerateLevel,1,0)
    i=i+1
  }
  i=1
j=j+1 # implement data after calculated to only looking at no change in sedimentation only Trace1 0% change in reservoir storage
}

#Severe
i=1
j=1
while (j<=108) {
  while (i<=359) {
    Storage_Rel_Metrics_Severe[i,j] <- ifelse(Tot_Stor[i,j]>SevereLevel,1,0)
    i=i+1
  }
  i=1
  j=j+1 # implement data after calculated to only looking at no change in sedimentation only Trace1 0% change in reservoir storage
}

#Extreme
i=1
j=1
while (j<=108) {
  while (i<=359) {
    Storage_Rel_Metrics_Extreme[i,j] <- ifelse(Tot_Stor[i,j]>ExtremeLevel,1,0)
    i=i+1
  }
  i=1
  j=j+1 # implement data after calculated to only looking at no change in sedimentation only Trace1 0% change in reservoir storage
}

#View(Storage_Rel_Metrics_Moderate)
#View(Storage_Rel_Metrics_Severe)
#View(Storage_Rel_Metrics_Extreme)

## Calculate Reliability
Stor_Rel_Moderate <- data.frame(Storage_Rel_Metrics_Moderate[1,])
Stor_Rel_Severe <- data.frame(Storage_Rel_Metrics_Severe[1,])
Stor_Rel_Extreme <- data.frame(Storage_Rel_Metrics_Extreme[1,])

i=1
while (i<=108) {
  Stor_Rel_Moderate[,i] <- round(sum((Storage_Rel_Metrics_Moderate[,i]/359)*100),1)
  i=i+1
}
SRM<- Stor_Rel_Moderate
x<-data.frame(colnames(Stor_Rel_Moderate))

i=1
while (i<=108) {
  Stor_Rel_Severe[,i] <- round(sum((Storage_Rel_Metrics_Severe[,i]/359)*100),1)
  i=i+1
}
SRS<- Stor_Rel_Severe


i=1
while (i<=108) {
  Stor_Rel_Extreme[,i] <- round(sum((Storage_Rel_Metrics_Extreme[,i]/359)*100),1)
  i=i+1
}
SRE<- Stor_Rel_Extreme


#transpose data
Stor_Rel_Moderate <- data.frame(t(Stor_Rel_Moderate))
Stor_Rel_Severe <- data.frame(t(Stor_Rel_Severe))
Stor_Rel_Extreme <- data.frame(t(Stor_Rel_Extreme))

#Plot Reliability -- Storage

p <- plot_ly( data = Stor_Rel_Moderate,
  x = x[1:108],
  y = Stor_Rel_Moderate[1:108,],
  type = 'scatter', mode = 'lines' #)%>%
  #layout(title = "Storage Reliablity"
  )
p

#Plot Reliability -- Storage -- No Sedimentation
library("data.table", lib.loc="~/R/win-library/3.5")

                  #Moderate
Stor_Rel_Moderate_NoSediment <- data.table(rep(0,36))
i=1
j=1
while (i<=36) {

Stor_Rel_Moderate_NoSediment[i,1] <- SRM[1,j]
i=i+1
j=j+3
}
#View(Stor_Rel_Moderate_NoSediment)
#Rename Row Names
i=1
for(TTTNum in 1:TraceNumber){
  for(TTNum in 1:TraceNumber1){
      TraceDirectory <- paste0(",Trace",TTNum)
      TraceNum1<- paste0("Trace",TTTNum)
      TraceDirectory <- paste0(TraceNum1,TraceDirectory)
      rownames(Stor_Rel_Moderate_NoSediment)[i] <-  TraceDirectory
      i=i+1
    }
  }


p <- plot_ly( data = Stor_Rel_Moderate_NoSediment,
              x = rownames(Stor_Rel_Moderate_NoSediment),
              y = Stor_Rel_Moderate_NoSediment$V1,
              type = 'scatter', mode = 'lines' #)%>%
              #layout(title = "Storage Reliablity"
)
p
                  #Severe
Stor_Rel_Severe_NoSediment <- data.table(rep(0,36))
i=1
j=1
while (i<=36) {

  Stor_Rel_Severe_NoSediment[i,1] <- SRS[1,j]
  i=i+1
  j=j+3
}
#View(Stor_Rel_Severe_NoSediment)
p <- plot_ly( data = Stor_Rel_Severe_NoSediment,
              x = rownames(Stor_Rel_Moderate_NoSediment),
              y = Stor_Rel_Severe_NoSediment$V1,
              type = 'scatter', mode = 'lines' #)%>%
              #layout(title = "Storage Reliablity"
)
p

                  #Extreme
Stor_Rel_Extreme_NoSediment <- data.table(rep(0,36))
i=1
j=1
while (i<=36) {

  Stor_Rel_Extreme_NoSediment[i,1] <- SRE[1,j]
  i=i+1
  j=j+3
}

#View(Stor_Rel_Extreme_NoSediment)
p <- plot_ly( data = Stor_Rel_Extreme_NoSediment,
              x = rownames(Stor_Rel_Moderate_NoSediment),
              y = Stor_Rel_Extreme_NoSediment$V1,
              type = 'scatter', mode = 'lines' #)%>%
              #layout(title = "Storage Reliablity"
)
p

## Plot All together

p <- plot_ly( data = Stor_Rel_Moderate_NoSediment,
              x = rownames(Stor_Rel_Moderate_NoSediment),
              y = Stor_Rel_Moderate_NoSediment$V1, name = 'Moderate Drought Level',
              type = 'scatter', mode = 'lines',line = list(color = "yellow"))%>%
              layout(title = "Storage Reliablity Levels Percentage"
) %>%
  add_trace(y=Stor_Rel_Severe_NoSediment$V1,name = 'Severe Drought Level' ,mode='lines',line =list(color="orange")) %>%
  add_trace(y=Stor_Rel_Extreme_NoSediment$V1,name = 'Extreme Drought Level',mode='lines',line=list(color = "red"))
p

