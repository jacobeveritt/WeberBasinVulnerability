# *------------------------------------------------------------------
# | PROGRAM NAME: Service Area Divided Annual Demands
                                                            #Copy intro page back in when done
#Set Working Directory
setwd("~/GitHub/WeberBasinVulnerability/WeberBasinVulnerability/1 - Scenario Processing/Annual Service Area Demand Scenarios/Input_Data")

### Clear any existing data or functions.
rm(list=ls())

##Possible package installation necessary
#install.packages("RColorBrewer")
#install.packages("plotly")
#install.packages("readxl")
#install.packages("openxlsx")
library(readxl)
library(plotly)
library(RColorBrewer)
library(openxlsx)

##Input Data Table of Contents##

## Municipal and Industrial water INPUTS
# 1- County Per Capita Usage
# 2- County Populations 2015, 2070, 2150
# 3- County Evapotranspiration
# 4- Per Capita Usage
#a)Indoor Municipal Per Capita: Same, Reduced, Drastically Reduced
#b)Outdoor Municipal Per Capita: Same, Reduced, Drastically Reduced
# 5- Misc.

#----------------------------### Inputs ### ------------------------------------------------------------------------------------------------------------------------------------------
#1 & #2 Inputs By County and Year (Population and Per Capita Usage)
D2015<-read.csv("2015Data.csv")
D2070<-read.csv("2070Data.csv")
D2150<-read.csv("2150Data.csv")

#3 Evapotranspiration
#Evapotranspiration Scenarios
# a. No Change (No Calculation Necessary) (+0% Secondary Usage)
# b. Increased Usage due to Evapotranspiration (+ 15% Secondary Usage)
# c. Decreased Usage due to Increased Evapotranspiration therefore greater Precipitation (-15% Secondary Usage)
ET_IncreaseFactor = 1.15
ET_DecreaseFactor = 0.85

#a.                       #No changes

#b.
D2015$IncET_Secondary.Use <- D2015$Secondary.Use*ET_IncreaseFactor
D2070$IncET_Secondary.Use <- D2070$Secondary.Use*ET_IncreaseFactor
D2150$IncET_Secondary.Use <- D2150$Secondary.Use*ET_IncreaseFactor

#c.
D2015$DecET_Secondary.Use <- D2015$Secondary.Use*ET_DecreaseFactor
D2070$DecET_Secondary.Use <- D2070$Secondary.Use*ET_DecreaseFactor
D2150$DecET_Secondary.Use <- D2150$Secondary.Use*ET_DecreaseFactor

#4 Scenarios Input (0%, 25% and 40% reduction)
ScenarioSA_PCntChanges <- read_excel("PercentChanges.xlsx")

#5 Misc Data
#Division of Water Resources Service Area Table
DWRSA_Table <- read_excel("DWRSA_Table.xlsx")
'_________________________________________________________________________________________________________________________________'

####################--Demand Calculations for Differing ET, Populations and Per-Capita Usage Reductions--#########################

#---------------------------------------------##ET Scenario a. No change to Usage due to ET (Same Case)###---------------------------------------

###Calculate Demand_Initial Per Capita values################################################################################################

#Calculate Demand by County For 2015, 2070 and 2150
  #Conversion Factor Gallons per day to Acre-feet per year
      GALtoAF <- 0.0000030688832459704*365

#2015
D2015$MI_County <- ((D2015$Population*D2015$Potable.Use) + (D2015$Population*D2015$Secondary.Use))*GALtoAF

#2070
D2070$MI_County <- ((D2070$Population*D2070$Potable.Use) + (D2070$Population*D2070$Secondary.Use))*GALtoAF

#2150
D2150$MI_County <- ((D2150$Population*D2150$Potable.Use) + (D2150$Population*D2150$Secondary.Use))*GALtoAF

#Allocating Demand from County Demand to Service Area Proportionally From DWRSA_Table

#2015
D2015$MI_SA <- D2015$MI_County*(DWRSA_Table$AVG/DWRSA_Table$`SUMS by County`)

#2070
D2070$MI_SA <- D2070$MI_County*(DWRSA_Table$AVG/DWRSA_Table$`SUMS by County`)

#2150
D2150$MI_SA <- D2150$MI_County*(DWRSA_Table$AVG/DWRSA_Table$`SUMS by County`)

###PerCapita Percent Changes (PCDecrease Scenario)###############################################################################################
  #Change The Input by ScenarioSA_PcntChanges
    #Decrease the Potable Use by 10%

DecPotable <- 0.90

#2015
  D2015$DecPotable.Use <- D2015$Potable.Use * DecPotable

#2070
  D2070$DecPotable.Use <- D2070$Potable.Use * DecPotable

#2150
  D2150$DecPotable.Use <- D2150$Potable.Use * DecPotable

#Decrease the Secondary Use by 34% to make total PerCapita reduction 25%

DecSecondary <- (1 - 0.34)

#2015
  D2015$DecSecondary.Use <- D2015$Secondary.Use * DecSecondary

#2070
  D2070$DecSecondary.Use <- D2070$Secondary.Use * DecSecondary

#2150
  D2150$DecSecondary.Use <- D2150$Secondary.Use * DecSecondary

######Calculate Demand Decreased Values###########################################################################################

  #Calculate Demand by County For 2015, 2070 and 2150
  #2015
  D2015$MI_County_PCDec <- ((D2015$Population*D2015$DecPotable.Use) + (D2015$Population*D2015$DecSecondary.Use))*GALtoAF

  #2070
  D2070$MI_County_PCDec <- ((D2070$Population*D2070$DecPotable.Use) + (D2070$Population*D2070$DecSecondary.Use))*GALtoAF

  #2150
  D2150$MI_County_PCDec <- ((D2150$Population*D2150$DecPotable.Use) + (D2150$Population*D2150$DecSecondary.Use))*GALtoAF

###Allocating Demand from County Demand to Service Area Proportionally From DWRSA_Table

  #2015
  D2015$MI_SA_PCDec <- D2015$MI_County_PCDec*(DWRSA_Table$AVG/DWRSA_Table$`SUMS by County`)

  #2070
  D2070$MI_SA_PCDec <- D2070$MI_County_PCDec*(DWRSA_Table$AVG/DWRSA_Table$`SUMS by County`)

  #2150
  D2150$MI_SA_PCDec <- D2150$MI_County_PCDec*(DWRSA_Table$AVG/DWRSA_Table$`SUMS by County`)

###With Per Capita Percent Changes  (Drastic Decrease (DD))#################################################################

  #Decrease the Potable Use by 20%

  DDPotable <- 0.80

  #2015
  D2015$DDPotable.Use <- D2015$Potable.Use * DDPotable

  #2070
  D2070$DDPotable.Use <- D2070$Potable.Use * DDPotable

  #2150
  D2150$DDPotable.Use <- D2150$Potable.Use * DDPotable

  #Decrease the Secondary Use by 44%

  DDSecondary <- (1 - 0.44)

  #2015
  D2015$DDSecondary.Use <- D2015$Secondary.Use * DDSecondary

  #2070
  D2070$DDSecondary.Use <- D2070$Secondary.Use * DDSecondary

  #2150
  D2150$DDSecondary.Use <- D2150$Secondary.Use * DDSecondary


######Calculate Demand Drastic Decreased Values##############################################################################

  #Calculate Demand by County For 2015, 2070 and 2150
  #2015
  D2015$MI_County_PCDD <- ((D2015$Population*D2015$DDPotable.Use) + (D2015$Population*D2015$DDSecondary.Use))*GALtoAF

  #2070
  D2070$MI_County_PCDD <- ((D2070$Population*D2070$DDPotable.Use) + (D2070$Population*D2070$DDSecondary.Use))*GALtoAF

  #2150
  D2150$MI_County_PCDD <- ((D2150$Population*D2150$DDPotable.Use) + (D2150$Population*D2150$DDSecondary.Use))*GALtoAF

  ###Allocating Demand from County Demand to Service Area Proportionally From DWRSA_Table

  #2015
  D2015$MI_SA_PCDD <- D2015$MI_County_PCDD*(DWRSA_Table$AVG/DWRSA_Table$`SUMS by County`)

  #2070
  D2070$MI_SA_PCDD <- D2070$MI_County_PCDD*(DWRSA_Table$AVG/DWRSA_Table$`SUMS by County`)

  #2150
  D2150$MI_SA_PCDD <- D2150$MI_County_PCDD*(DWRSA_Table$AVG/DWRSA_Table$`SUMS by County`)


#----------------------------------- ###ET Scenario b. Increase to Usage due to ET (Increase Case)### --------------------------

###Calculate Demand_Initial Per Capita values###################################################################################
    #Calculate Demand by County For 2015, 2070 and 2150

  #2015
  D2015$MI_County_ETInc <- ((D2015$Population*D2015$Potable.Use) + (D2015$Population*D2015$IncET_Secondary.Use ))*GALtoAF

  #2070
  D2070$MI_County_ETInc <- ((D2070$Population*D2070$Potable.Use) + (D2070$Population*D2070$IncET_Secondary.Use))*GALtoAF

  #2150
  D2150$MI_County_ETInc <- ((D2150$Population*D2150$Potable.Use) + (D2150$Population*D2150$IncET_Secondary.Use))*GALtoAF

####Allocating Demand from County Demand to Service Area Proportionally From DWRSA_Table

  #2015
  D2015$MI_SA_ETInc <- D2015$MI_County_ETInc*(DWRSA_Table$AVG/DWRSA_Table$`SUMS by County`)

  #2070
  D2070$MI_SA_ETInc <- D2070$MI_County_ETInc*(DWRSA_Table$AVG/DWRSA_Table$`SUMS by County`)

  #2150
  D2150$MI_SA_ETInc <- D2150$MI_County_ETInc*(DWRSA_Table$AVG/DWRSA_Table$`SUMS by County`)


  ###PerCapita Percent Changes (PCDecrease Scenario)#############################################################################
  #Change The Input by ScenarioSA_PcntChanges
  #Decrease the Potable Use by 10%

  #DecPotable Values won't change with ET

  #Decrease the Secondary Use by 34% to make total PerCapita reduction 25%

  DecSecondary <- (1 - 0.34)

  #2015
  D2015$DecSecondary.Use_ETInc <- D2015$IncET_Secondary.Use * DecSecondary

  #2070
  D2070$DecSecondary.Use_ETInc <- D2070$IncET_Secondary.Use * DecSecondary

  #2150
  D2150$DecSecondary.Use_ETInc <- D2150$IncET_Secondary.Use * DecSecondary

  ######Calculate Demand Decreased Values########################################################################################

  #Calculate Demand by County For 2015, 2070 and 2150
  #2015
  D2015$MI_County_PCDec_ETInc <- ((D2015$Population*D2015$DecPotable.Use) + (D2015$Population*D2015$DecSecondary.Use_ETInc))*GALtoAF

  #2070
  D2070$MI_County_PCDec_ETInc <- ((D2070$Population*D2070$DecPotable.Use) + (D2070$Population*D2070$DecSecondary.Use_ETInc))*GALtoAF

  #2150
  D2150$MI_County_PCDec_ETInc <- ((D2150$Population*D2150$DecPotable.Use) + (D2150$Population*D2150$DecSecondary.Use_ETInc))*GALtoAF

  ###Allocating Demand from County Demand to Service Area Proportionally From DWRSA_Table

  #2015
  D2015$MI_SA_PCDec_ETInc <- D2015$MI_County_PCDec_ETInc*(DWRSA_Table$AVG/DWRSA_Table$`SUMS by County`)

  #2070
  D2070$MI_SA_PCDec_ETInc <- D2070$MI_County_PCDec_ETInc*(DWRSA_Table$AVG/DWRSA_Table$`SUMS by County`)

  #2150
  D2150$MI_SA_PCDec_ETInc <- D2150$MI_County_PCDec_ETInc*(DWRSA_Table$AVG/DWRSA_Table$`SUMS by County`)

  ###With Per Capita Percent Changes  (Drastic Decrease (DD))####################################################################

  #Decrease the Potable Use by 20%

  #DDPotable Values won't change with ET

  #Decrease the Secondary Use by 44%

  DDSecondary <- (1 - 0.44)

  #2015
  D2015$DDSecondary.Use_ETInc <- D2015$IncET_Secondary.Use * DDSecondary

  #2070
  D2070$DDSecondary.Use_ETInc <- D2070$IncET_Secondary.Use * DDSecondary

  #2150
  D2150$DDSecondary.Use_ETInc <- D2150$IncET_Secondary.Use * DDSecondary


######Calculate Demand Drastic Decreased Values#################################################################################

  #Calculate Demand by County For 2015, 2070 and 2150
  #2015
  D2015$MI_County_PCDD_ETInc <- ((D2015$Population*D2015$DDPotable.Use) + (D2015$Population*D2015$DDSecondary.Use_ETInc))*GALtoAF

  #2070
  D2070$MI_County_PCDD_ETInc <- ((D2070$Population*D2070$DDPotable.Use) + (D2070$Population*D2070$DDSecondary.Use_ETInc))*GALtoAF

  #2150
  D2150$MI_County_PCDD_ETInc <- ((D2150$Population*D2150$DDPotable.Use) + (D2150$Population*D2150$DDSecondary.Use_ETInc))*GALtoAF


###Allocating Demand from County Demand to Service Area Proportionally From DWRSA_Table
  #2015
  D2015$MI_SA_PCDD_ETInc <- D2015$MI_County_PCDD_ETInc*(DWRSA_Table$AVG/DWRSA_Table$`SUMS by County`)

  #2070
  D2070$MI_SA_PCDD_ETInc <- D2070$MI_County_PCDD_ETInc*(DWRSA_Table$AVG/DWRSA_Table$`SUMS by County`)

  #2150
  D2150$MI_SA_PCDD_ETInc <- D2150$MI_County_PCDD_ETInc*(DWRSA_Table$AVG/DWRSA_Table$`SUMS by County`)

#----------------------------------- ###ET Scenario c. Decrease to Usage due to ET (Decrease Case)### ----------------------------
###Calculate Demand_Initial Per Capita values#####################################################################################

  #Calculate Demand by County For 2015, 2070 and 2150
  #Conversion Factor Gallons per day to Acre-feet per year
  GALtoAF <- 0.0000030688832459704*365

  #2015
  D2015$MI_County_ETDec <- ((D2015$Population*D2015$Potable.Use) + (D2015$Population*D2015$DecET_Secondary.Use))*GALtoAF

  #2070
  D2070$MI_County_ETDec <- ((D2070$Population*D2070$Potable.Use) + (D2070$Population*D2070$DecET_Secondary.Use))*GALtoAF

  #2150
  D2150$MI_County_ETDec <- ((D2150$Population*D2150$Potable.Use) + (D2150$Population*D2150$DecET_Secondary.Use))*GALtoAF

##Allocating Demand from County Demand to Service Area Proportionally From DWRSA_Table
  #2015
  D2015$MI_SA_ETDec <- D2015$MI_County_ETDec*(DWRSA_Table$AVG/DWRSA_Table$`SUMS by County`)

  #2070
  D2070$MI_SA_ETDec <- D2070$MI_County_ETDec*(DWRSA_Table$AVG/DWRSA_Table$`SUMS by County`)

  #2150
  D2150$MI_SA_ETDec <- D2150$MI_County_ETDec*(DWRSA_Table$AVG/DWRSA_Table$`SUMS by County`)

###PerCapita Percent Changes (PCDecrease Scenario)#################################################################################

  #Change The Input by ScenarioSA_PcntChanges
  #Decrease the Potable Use by 10%

  #DecPotable Values won't change with ET

  #Decrease the Secondary Use by 34% to make total PerCapita reduction 25%

  DecSecondary <- (1 - 0.34)

  #2015
  D2015$DecSecondary.Use_ETDec <- D2015$DecET_Secondary.Use * DecSecondary

  #2070
  D2070$DecSecondary.Use_ETDec <- D2070$DecET_Secondary.Use * DecSecondary

  #2150
  D2150$DecSecondary.Use_ETDec <- D2150$DecET_Secondary.Use * DecSecondary

  ######Calculate Demand Decreased Values###########################################################################################

  #Calculate Demand by County For 2015, 2070 and 2150
  #2015
  D2015$MI_County_PCDec_ETDec <- ((D2015$Population*D2015$DecPotable.Use) + (D2015$Population*D2015$DecSecondary.Use_ETDec))*GALtoAF

  #2070
  D2070$MI_County_PCDec_ETDec <- ((D2070$Population*D2070$DecPotable.Use) + (D2070$Population*D2070$DecSecondary.Use_ETDec))*GALtoAF

  #2150
  D2150$MI_County_PCDec_ETDec <- ((D2150$Population*D2150$DecPotable.Use) + (D2150$Population*D2150$DecSecondary.Use_ETDec))*GALtoAF

###Allocating Demand from County Demand to Service Area Proportionally From DWRSA_Table

  #2015
  D2015$MI_SA_PCDec_ETDec <- D2015$MI_County_PCDec_ETDec*(DWRSA_Table$AVG/DWRSA_Table$`SUMS by County`)

  #2070
  D2070$MI_SA_PCDec_ETDec <- D2070$MI_County_PCDec_ETDec*(DWRSA_Table$AVG/DWRSA_Table$`SUMS by County`)

  #2150
  D2150$MI_SA_PCDec_ETDec <- D2150$MI_County_PCDec_ETDec*(DWRSA_Table$AVG/DWRSA_Table$`SUMS by County`)

###With Per Capita Percent Changes  (Drastic Decrease (DD))########################################################################
  #Decrease the Potable Use by 20%

  #DDPotable Values won't change with ET

  #Decrease the Secondary Use by 44%

  DDSecondary <- (1 - 0.44)

  #2015
  D2015$DDSecondary.Use_ETDec <- D2015$DecET_Secondary.Use * DDSecondary

  #2070
  D2070$DDSecondary.Use_ETDec <- D2070$DecET_Secondary.Use * DDSecondary

  #2150
  D2150$DDSecondary.Use_ETDec <- D2150$DecET_Secondary.Use * DDSecondary


  ######Calculate Demand Drastic Decreased Values################################################################################

  #Calculate Demand by County For 2015, 2070 and 2150
  #2015
  D2015$MI_County_PCDD_ETDec <- ((D2015$Population*D2015$DDPotable.Use) + (D2015$Population*D2015$DDSecondary.Use_ETDec))*GALtoAF

  #2070
  D2070$MI_County_PCDD_ETDec <- ((D2070$Population*D2070$DDPotable.Use) + (D2070$Population*D2070$DDSecondary.Use_ETDec))*GALtoAF

  #2150
  D2150$MI_County_PCDD_ETDec <- ((D2150$Population*D2150$DDPotable.Use) + (D2150$Population*D2150$DDSecondary.Use_ETDec))*GALtoAF

###Allocating Demand from County Demand to Service Area Proportionally From DWRSA_Table
  #2015
  D2015$MI_SA_PCDD_ETDec <- D2015$MI_County_PCDD_ETDec*(DWRSA_Table$AVG/DWRSA_Table$`SUMS by County`)

  #2070
  D2070$MI_SA_PCDD_ETDec <- D2070$MI_County_PCDD_ETDec*(DWRSA_Table$AVG/DWRSA_Table$`SUMS by County`)

  #2150
  D2150$MI_SA_PCDD_ETDec <- D2150$MI_County_PCDD_ETDec*(DWRSA_Table$AVG/DWRSA_Table$`SUMS by County`)


###     Outputs    ################################################################################################################
  setwd("~/GitHub/WeberBasinVulnerability/WeberBasinVulnerability/1 - Scenario Processing/Annual Service Area Demand Scenarios/Output")

#  View(D2015)
#  View(D2070)
#  View(D2150)

#MI ONLY

MI_2015 <- D2015[,c(9,13,17,19,22,25,27,30,33)]
MI_2070 <- D2070[,c(9,13,17,19,22,25,27,30,33)]
MI_2150 <- D2150[,c(9,13,17,19,22,25,27,30,33)]

#add Utah County SA1 Data 35500 to top row
MI_2015[1,]<-35500
MI_2070[1,]<-35500
MI_2150[1,]<-35500

#add SA20 to be 0
MI_2015[20,]<-0
MI_2070[20,]<-0
MI_2150[20,]<-0


colnames(MI_2015) <- paste(colnames(MI_2015),"2015",sep="_")

colnames(MI_2070) <- paste(colnames(MI_2070),"2070",sep="_")

colnames(MI_2150) <- paste(colnames(MI_2150),"2150",sep="_")

MI<- data.frame(c(MI_2015,MI_2070,MI_2150))

#View(MI)

#output to excel
write.xlsx(MI_2015, "MI_2015.xlsx")
write.xlsx(MI_2070, "MI_2070.xlsx")
write.xlsx(MI_2150, "MI_2150.xlsx")

write.xlsx(MI,"MI.xlsx")

#################################################################################################################################################################################################################################################################################################################################################################################################################################################
### Sum Data for plots ###
#################################################################################################################################################################################################################################################################################################################################################################################################################################################

#MI Sums

MISums <- colSums(MI,na.rm=F,dims = 1)
MISums
MISums <-data.frame(MISums)


#SummedScenarios <- data.frame(c(MI2015_Sums,MI2070_Sums,MI2150_Sums))
#row.names(SummedScenarios) <- c("Base","PCDec","PCDD","ETInc","PCDec_ETInc","PCDD_ETInc","ETDec","PCDec_ETDec","PCDD_ETDec")

#2015 Sums
MI2015_Sums <- colSums(MI_2015,na.rm = F, dims = 1)
MI2015_Sums <- data.frame(MI2015_Sums)
#MI2015_Sums$ET <-  c(rep('SameET',3),rep('DecreaseET',3),rep('IncreaseET',3))
#MI2015_Sums$PC <-  rep(c('SamePC','DecreasePC','DrasticDecreasePC'),3)
#MI2015_Sums$NUMPC <-  rep(c(3000,2000,1000),3)
#2070 Sums
MI2070_Sums <- colSums(MI_2070,na.rm = F, dims = 1)
MI2070_Sums <- data.frame(MI2070_Sums)
#MI2070_Sums$ET <- rep(c(rep('SameET',3),rep('DecreaseET',3),rep('IncreaseET',3)),3)
#MI2070_Sums$PC <- rep(rep(c('SamePC','DecreasePC','DrasticDecreasePC'),3),3)
#MI2070_Sums$NUMPC <- rep(rep(c(3000,2000,1000),3),3)
#2150 Sums
MI2150_Sums <- colSums(MI_2150,na.rm = F, dims = 1)
MI2150_Sums <- data.frame(MI2150_Sums)
#MI2150_Sums$ET <- rep(c(rep('SameET',3),rep('DecreaseET',3),rep('IncreaseET',3)),3)
#MI2150_Sums$PC <- rep(rep(c('SamePC','DecreasePC','DrasticDecreasePC'),3),3)
#MI2150_Sums$NUMPC <- rep(rep(c(3000,2000,1000),3),3)

SummedScenarios <- data.frame(c(MI2015_Sums,MI2070_Sums,MI2150_Sums))
row.names(SummedScenarios) <- c("Base","PCDec","PCDD","ETInc","PCDec_ETInc","PCDD_ETInc","ETDec","PCDec_ETDec","PCDD_ETDec")
RowNames <- c("Base","PCDec_ETSame","PCDrD_ETSame","PCBase_ETInc","PCDec_ETInc","PCDrD_ETInc","PCBase_ETDec","PCDec_ETDec","PCDrD_ETDec")

#################################################################################################################################################################################################################################################################################################################################################################################################################################################
### Plots ###
#################################################################################################################################################################################################################################################################################################################################################################################################################################################

#Barplots
Dates <- c("2015", "2070", "2150")

#Per Capita
plot_ly(data=SummedScenarios,x=RowNames, y= ~ MI2015_Sums ,type = 'bar',name = "2015") %>%
  add_trace(x=RowNames, y= ~ MI2070_Sums,name = "2070") %>%
  add_trace(x=RowNames,y = ~ MI2150_Sums, name = "2150") %>%
  layout(yaxis=list(title = 'M&I Demand (acre-feet)',barmode = 'group'))

