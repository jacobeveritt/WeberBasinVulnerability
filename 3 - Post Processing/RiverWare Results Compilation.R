#Output Data Compilation

### Clear any existing data or functions.
rm(list=ls())
library("dplyr", lib.loc="~/R/win-library/3.5")

###Total Storage Compilation#--------------------------------------------------------------------------------#

setwd("~/GitHub/WeberBasinVulnerability/WeberBasinVulnerability/2 - RiverWare Modeling/Scenario")
library(readr)

#Plots
####-----------------------------Trace Notation--------------------------------------------------
TraceNumber <- 6
TraceNumber1 <-6
TraceNumber2 <-3
Tot_TraceNum <- TraceNumber*TraceNumber1*TraceNumber2

Trace_Notation <-c(1:Tot_TraceNum)
i=1
for(TTTNum in 1:TraceNumber){
  for(TTNum in 1:TraceNumber1){
    for(TNum in 1:TraceNumber2){
      TraceDirectory <- paste0(",Trace",TNum)
      TraceNum1<- paste0(",Trace",TTNum)
      TraceDirectory <- paste0(TraceNum1,TraceDirectory)
      TraceNum2 <- paste0("Trace",TTTNum)
      TraceDirectory <- paste0(TraceNum2,TraceDirectory)

      Trace_Notation[i] <-  TraceDirectory
      i=i+1
    }
  }
}

#View(Trace_Notation)

##################################Input data########################################################
Tot_Stor <- read.csv("Trace1,Trace1,Trace1/Total Storage_NO EVAP.csv")
Tot_Inflow <-read.csv("Trace1,Trace1,Trace1/Total Inflows.csv")
Tot_Short <-read.csv("Trace1,Trace1,Trace1/Total Shortages.csv")

#Create TraceFolder Naming lookup for Values with No Evap.

                         ##### Total Storage #####
i=1
 for(TTTNum in 1:TraceNumber){
   for(TTNum in 1:TraceNumber1){
     for(TNum in 1:TraceNumber2){
       TraceDirectory <- paste0(",Trace",TNum)
       TraceDirectory <-paste0 (TraceDirectory,"/Total Storage_NO EVAP.csv")
       TraceNum1<- paste0(",Trace",TTNum)
       TraceDirectory <- paste0(TraceNum1,TraceDirectory)
       TraceNum2 <- paste0("Trace",TTTNum)
       TraceDirectory <- paste0(TraceNum2,TraceDirectory)

       Location <- TraceDirectory
       Temp_Storage <- read_csv(Location)
       Tot_Stor[,i] <- Temp_Storage[,5]

       colnames(Tot_Stor)[i] <-  TraceDirectory
 i=i+1
     }
   }
 }
Tot_Stor <- data.frame(Tot_Stor)

# colnames(Tot_Stor) <- Trace_Notation

 #add Date column
 Date <- seq.Date(as.Date("0000/11/30"),by ="month",length=359)

 #Tot_Stor$Date <- Date
  Months <- rep(c(1:12),31)
  Months<- Months[(11:369)]
 #Tot_Stor$Month <- data.frame(Months)

 #Create Years
 Years <- c(0:372)
 i=1
 j=1
 while (j<=31) {
   Years[(i:(i+11))] <- rep((j-1),12)
   i=i+12
   j=j+1
 }
 Years<- Years[(11:369)]
 #Tot_Stor$Year <- data.frame(Years)


 #transpose
 Tot_Stor <- t(Tot_Stor)

 Tot_Stor <- data.frame(Tot_Stor)

 colnames(Tot_Stor) <-  Date

#View(Tot_Stor)

  ### Total Inflows
i=1
      for(TTTNum in 1:TraceNumber){
        for(TTNum in 1:TraceNumber1){
          for(TNum in 1:TraceNumber2){
            TraceDirectory <- paste0(",Trace",TNum)
            TraceDirectory <-paste0 (TraceDirectory,"/Total Inflows.csv")
            TraceNum1<- paste0(",Trace",TTNum)
            TraceDirectory <- paste0(TraceNum1,TraceDirectory)
            TraceNum2 <- paste0("Trace",TTTNum)
            TraceDirectory <- paste0(TraceNum2,TraceDirectory)

      Location <- TraceDirectory
      Temp_Storage <- read_csv(Location)
      Tot_Inflow[,i] <- Temp_Storage[,5]

      colnames(Tot_Inflow)[i] <-  TraceDirectory
      i=i+1
    }
  }
}

Tot_Inflow <- data.frame(Tot_Inflow)

#colnames(Tot_Inflow)<- Trace_Notation

   #add Date column
   #Tot_Inflow$Date <-Date
   #Tot_Inflow$Month <- data.frame(Months)
   #Tot_Inflow$Year <- data.frame(Years)

#transpose
   Tot_Inflow <- t(Tot_Inflow)

   Tot_Inflow <- data.frame(Tot_Inflow)
   # column names
   colnames(Tot_Inflow) <-Date

  #View(Tot_Inflow)

                                    ##### Total Shortages #####
   i=1
   for(TTTNum in 1:TraceNumber){
     for(TTNum in 1:TraceNumber1){
       for(TNum in 1:TraceNumber2){
         TraceDirectory <- paste0(",Trace",TNum)
         TraceDirectory <-paste0 (TraceDirectory,"/Total Shortages.csv")
         TraceNum1<- paste0(",Trace",TTNum)
         TraceDirectory <- paste0(TraceNum1,TraceDirectory)
         TraceNum2 <- paste0("Trace",TTTNum)
         TraceDirectory <- paste0(TraceNum2,TraceDirectory)
      Location <- TraceDirectory
      Temp_Storage <- read_csv(Location)
      Tot_Short[,i] <- Temp_Storage[,5]
      colnames(Tot_Short)[i] <-  TraceDirectory
      i=i+1
    }
     }
       }
  Tot_Short <- data.frame(Tot_Short)

  #colnames(Tot_Short) <- Trace_Notation

  #add Date column
  #Tot_Short$Date <- Date
  #Tot_Short$Month <- data.frame(Months)
  #Tot_Short$Year <- data.frame(Years)
  #transpose
  Tot_Short <- t(Tot_Short)
  Tot_Short <- data.frame(Tot_Short)
  # column names
  colnames(Tot_Short) <- Date
#View(Tot_Short)

##Total Sedimentation Changes on Reservoir
setwd("~/GitHub/WeberBasinVulnerability/WeberBasinVulnerability/3 - Post Processing")

Tot_Sed <- read_csv("Sedimentation.csv")
Tot_Sed <-data.frame(Tot_Sed)
#Tot_Sed$Date <- Date

colnames(Tot_Sed) <- Date
rownames(Tot_Sed) <- Trace_Notation

#View(Tot_Sed)
                                      ######## Total Demand #########

Tot_Demand <- read_csv("SumMIandAG.csv")
#View(SumMIandAG)

Tot_Demand <- data.frame(Tot_Demand)

colnames(Tot_Demand) <- Date
rownames(Tot_Demand) <- Trace_Notation
#View(Tot_Demand)

                                ##### Merge ##### AllData Dataframe

AllDataDF <- rbind(Tot_Inflow,Tot_Demand,Tot_Stor,Tot_Short,Tot_Sed)

AllDataDF <- data.frame(AllDataDF)

colnames(AllDataDF) <- Date

#View(AllDataDF)

# Add Date Rows

#AllDataDF[541,] <- Date
#rownames(AllDataDF)[541] <- "Date"

#AllDataDF[541,] <- Years
#rownames(AllDataDF)[541] <- "Year"

#AllDataDF[542,] <- Months
#rownames(AllDataDF)[542] <- "Month"

#View(AllDataDF)

#View(Date)

#############################################################################################
#June 1st Total Values Storage, Shortages?, Inflows, Demands and Sedimentations Scenarios
#############################################################################################

#June 1st AllDataDF

AllDataJ1DF <- AllDataDF[,1]
AllDataJ1DF <- data.frame(AllDataJ1DF)
Date_J1 <- c(1:30)
i=1
j=8
while (j<=359) {
AllDataJ1DF[,i] <- AllDataDF[,j]

Date_J1[i] <- Date[j]
i=i+1
  j=j+12
  }

AllDataJ1DF <- data.frame(AllDataJ1DF)
Date_J1 <- data.frame(Date_J1)
#View(AllDataJ1DF)


  ###########################################################################################################
  ############################Compile all data into one data.frame###########################################
  ###########################################################################################################
  #Storage Data in one Column

  Stacked_Inflow_June1 <- stack(AllDataJ1DF[1:108,1:30])
  Stacked_Demand_June1 <- stack(AllDataJ1DF[109:216,1:30])
  Stacked_Stor_June1 <- stack(AllDataJ1DF[217:324,1:30])
  Stacked_Shortage_June1 <- stack(AllDataJ1DF[325:432,1:30])
  Stacked_Sed_June1 <- stack(AllDataJ1DF[433:540,1:30])
  Stacked_Traces_June1 <- rep(Trace_Notation,30)

### Add Trace Notation to Stacked Values

  Stacked_Inflow_June1[2] <- Stacked_Traces_June1
  Stacked_Demand_June1[2] <- Stacked_Traces_June1
  Stacked_Stor_June1[2] <- Stacked_Traces_June1
  Stacked_Shortage_June1[2] <- Stacked_Traces_June1
  Stacked_Sed_June1[2] <- Stacked_Traces_June1

  #Rename Columns
  names(Stacked_Inflow_June1)[2] <- paste("Traces")
  names(Stacked_Inflow_June1)[1] <- paste("Inflows")
  names(Stacked_Demand_June1)[2] <- paste("Traces")
  names(Stacked_Demand_June1)[1] <- paste("Demand")
  names(Stacked_Stor_June1)[2] <- paste("Traces")
  names(Stacked_Stor_June1)[1] <- paste("Storage")
  names(Stacked_Shortage_June1)[2] <- paste("Traces")
  names(Stacked_Shortage_June1)[1] <- paste("Shortages")
  names(Stacked_Sed_June1)[2] <- paste("Traces")
  names(Stacked_Sed_June1)[1] <- paste("Sedimentation")

  #Merge Data frames
  J1Data <- Stacked_Inflow_June1
  J1Data$Demand <- Stacked_Demand_June1$Demand
  J1Data$Storage <- Stacked_Stor_June1$Storage
  J1Data$Shortage <- Stacked_Shortage_June1$Shortages
  J1Data$Sedimentation <-Stacked_Sed_June1$Sedimentation
#View(J1Data)

## Filter Sedimentation
  
  J1Data_NoSed <- filter(J1Data,Sedimentation==0)
  J1Data_10Perc <- filter(J1Data,Sedimentation==10)
  J1Data_30Perc <- filter(J1Data,Sedimentation==30)
  
##################################################################################################
###PLOTS###
##################################################################################################
  library(plotly)

  if (!require("processx")) install.packages("processx")
  setwd("~/GitHub/WeberBasinVulnerability/WeberBasinVulnerability/3 - Post Processing/Output")

###################### Contour Plots ############################################################

#Shortage
  p <- plot_ly(
    x = J1Data$Demand,
    y = J1Data$Inflows,
    z = J1Data$Shortage, type = "contour")%>%
    colorbar(title = "Shortage Level")%>%
    layout(title = "June 1st Shortages by Color",
           xaxis = list(title ="Demand"),
           yaxis = list(title = "Inflows"))
  p
# 0% Sedimentation
  p <- plot_ly(
    x = J1Data_NoSed$Demand,
    y = J1Data_NoSed$Inflows,
    z = J1Data_NoSed$Shortage, type = "contour")%>%
    colorbar(title="Shortage Level") %>%
    layout(title = "No Sedimentation Shortages by Color",
           xaxis = list(title ="Demand"),
           yaxis = list(title = "Inflows"))
  p
# 10% Sedimentation
  p <- plot_ly(
    x = J1Data_10Perc$Demand,
    y = J1Data_10Perc$Inflows,
    z = J1Data_10Perc$Shortage, type = "contour")%>%
    colorbar(title="Shortage Level") %>%
    layout(title = "10% Sedimentation Shortages by Color",
           xaxis = list(title ="Demand"),
           yaxis = list(title = "Inflows"))
  p
# 30% Sedimentation
  p <- plot_ly(
    x = J1Data_30Perc$Demand,
    y = J1Data_30Perc$Inflows,
    z = J1Data_30Perc$Shortage, type = "contour")%>%
    colorbar(title="Shortage Level") %>%
    layout(title = "30% Sedimentation Shortages by Color",
           xaxis = list(title ="Demand"),
           yaxis = list(title = "Inflows"))
  p
#Storage
  p <- plot_ly(
    x = J1Data$Demand,
    y = J1Data$Inflows,
    z = J1Data$Storage, type = "contour")%>%
  colorbar(title="Storage Level")%>%
    layout(title = "All Data Storage by Color",
           xaxis = list(title ="Demand"),
           yaxis = list(title = "Inflows"))
      p
#0% Reservior Change to Sed
    p <- plot_ly(
        x = J1Data_NoSed$Demand,
        y = J1Data_NoSed$Inflows,
        z = J1Data_NoSed$Storage, type = "contour")%>%
        layout(title = "No Sedimentation Storage by Color",
               xaxis = list(title ="Demand"),
               yaxis = list(title = "Inflows"))
      p
#10% Reservior Change to Sed
      p <- plot_ly(
        x = J1Data_10Perc$Demand,
        y = J1Data_10Perc$Inflows,
        z = J1Data_10Perc$Storage, type = "contour")%>%
        layout(title = "10% Sedimentation Storage by Color",
               xaxis = list(title ="Demand"),
               yaxis = list(title = "Inflows"))
      p
      
      
#30% Reservior Change to Sed
      p <- plot_ly(
        x = J1Data_30Perc$Demand,
        y = J1Data_30Perc$Inflows,
        z = J1Data_30Perc$Storage, type = "contour")%>%
        layout(title = "30% Sedimentation Storage by Color",
               xaxis = list(title ="Demand"),
               yaxis = list(title = "Inflows"))
      p
      
# Sedimentation   -- Issues with only plotting the 30% level for the sedimentation
  #p <- plot_ly(
    #x = J1Data$Demand,
    #y = J1Data$Inflows,
    #z = J1Data$Sedimentation, type = "contour")%>%
    #layout(title = "Sedimentation by Color",
    #       xaxis = list(title="Demand"),
   #        yaxis = list(title="Inflows"))
  #p

  #p <- plot_ly(
    #x = J1Data$Demand,
   # y = J1Data$Sedimentation,
  #  z = J1Data$Inflows, type = "contour")%>%
   # layout(title = "Sedimentation by Color",
  #         xaxis = list(title="Demand"),
 #          yaxis = list(title="Sedimentation"))
#  p


############ Storage Contours based on Moderate, Severe and Extreme Storage Drought Levels  #############################
   #Storage
  p <- plot_ly(
    x = J1Data$Demand,
    y = J1Data$Inflows,
    z = J1Data$Storage, type = "contour",
    colors = c("red","orange","yellow","white"),
    #contours = list(coloring = 'heatmap'),
    autocontour = F,contours = list(
      start = 280000,
      end = 380000,
      size = 50000
    ))%>%
    layout(title = "Storage by Color",
           xaxis = list(title ="Demand"),
           yaxis = list(title = "Inflows"))
  p

  #Storage
  p <- plot_ly(
    x = J1Data_NoSed$Demand,
    y = J1Data_NoSed$Inflows,
    z = J1Data_NoSed$Storage, type = "contour",
    colors = c("red","orange","yellow","white"),
    #contours = list(coloring = 'heatmap'),
    autocontour = F,contours = list(
      start = 280000,
      end = 380000,
      size = 50000
    ))%>%
    colorbar(title="Storage Level")%>%
    layout(title = "Storage by Color",
           xaxis = list(title ="Demand"),
           yaxis = list(title = "Inflows"))
  p
  
  p <- plot_ly(
    x = J1Data_10Perc$Demand,
    y = J1Data_10Perc$Inflows,
    z = J1Data_10Perc$Storage, type = "contour",
    colors = c("red","orange","yellow","white"),
    #contours = list(coloring = 'heatmap'),
    autocontour = F,contours = list(
      start = 280000,
      end = 380000,
      size = 50000
    ))%>%
    colorbar(title="Storage Level")%>%
    layout(title = "Storage by Color",
           xaxis = list(title ="Demand"),
           yaxis = list(title = "Inflows"))
  p
  
  p <- plot_ly(
    x = J1Data_NoSed$Demand,
    y = J1Data_NoSed$Inflows,
    z = J1Data_NoSed$Storage, type = "contour",
    colors = c("red","orange","yellow","white"),
    #contours = list(coloring = 'heatmap'),
    autocontour = F,contours = list(
      start = 280000,
      end = 380000,
      size = 50000
    ))%>%
    colorbar(title="Storage Level")%>%
    layout(title = "Storage by Color",
           xaxis = list(title ="Demand"),
           yaxis = list(title = "Inflows"))
  p
  
  
#Set all data above 380,000 acreft of storage to NA in order to show other levels more effectively

  NData <- filter(J1Data_NoSed,Storage<380000)
  
  #Storage
  p <- plot_ly(
    x = NData$Demand,
    y = NData$Inflows,
    z = NData$Storage, type = "contour",
    colors = c("red","orange","yellow","white"),
    #contours = list(coloring = 'heatmap',colors = c("red","orange","yellow","white")),
    autocontour = F,contours = list(
      start = 280000,
      end = 380000,
      size = 50000
    ))%>%
    layout(title = "Storage by Color",
           xaxis = list(title ="Demand"),
           yaxis = list(title = "Inflows"))
  p

### Get rid of 0 Values in Shortages

newData <- filter(J1Data, Shortage>0)
  

#######################Plot New Data with no Zeros #####################################
#Shortage
p <- plot_ly(
  x = newData$Demand,
  y = newData$Inflows,
  z = newData$Shortage, type = "contour")%>%
  layout(title = "Shortages by Color",
         xaxis = list(title ="Demand"),
         yaxis = list(title = "Inflows"))
p

#Storage  
p <- plot_ly(
  x = newData$Demand,
  y = newData$Inflows,
  z = newData$Storage, type = "contour")%>%
  layout(title = "Storage by Color",
         xaxis = list(title ="Demand"),
         yaxis = list(title = "Inflows"))
p


p <- plot_ly(
  x = newData$Demand,
  y = newData$Inflows,
  z = newData$Storage, type = "contour",
  colors = c("red","orange","yellow","white"),
  #contours = list(coloring = 'heatmap',colors = c("red","orange","yellow","white")),
  autocontour = F,contours = list(
    start = 280000,
    end = 380000,
    size = 50000,
    showlabels = TRUE
  ))%>% colorbar(title = "Storage Level") %>%
   layout(title = "Storage by Color",
         xaxis = list(title ="Demand"),
         yaxis = list(title = "Inflows"))
p

# Sedimentation & Shortage
p <- plot_ly(
  x = newData$Sedimentation,
  y = newData$Inflows,
  z = newData$Shortage,type = "contour")%>%
  layout(title = "Sedimentation by Color",
         xaxis = list(title="Sedimentation"),
         yaxis = list(title="Inflows"))
p


########## Plot Scatter Plots ###########
### Individual plots
#X = Demand, Y= Inflows
p <- plot_ly(newData,x =newData$Demand,y=newData$Inflows ,color = newData$Storage,colors = blues9)%>%
  layout(title = "Storage by Color",
         xaxis = list(title ="Demand"),
         yaxis = list(title = "Inflows"))
p

#X = Demand, Y= Inflows Z = Shortages
p <- plot_ly(newData,x =newData$Demand,y=newData$Inflows ,color = newData$Shortages,colors = blues9)%>%   #How to ignore 0 values
  layout(title = "Shortages by Color",
         xaxis = list(title ="Demand"),
         yaxis = list(title = "Inflows"))
p

#X = Shortage, Y= Storage Z= Demands
p <- plot_ly(newData,x =newData$Shortage,y=newData$Storage ,color = newData$Demand) %>%
  layout(title = "Demand by Color",
         xaxis = list(title ="Shortage (Acre-Feet)"),
         yaxis = list(title = "Storage (Acre-Feet)"))                       
p

#X = Shortage, Y= Storage Z= Inflows
p <- plot_ly(newData,x =newData$Shortage,y=newData$Storage ,color = newData$Inflows)%>%
  layout(title = "Inflows by Color",
         xaxis = list(title ="Shortage (Acre-Feet)"),
         yaxis = list(title = "Storage (Acre-Feet)"))
p

                                                  ############ End of June 1 code##########
