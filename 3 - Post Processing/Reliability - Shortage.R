
library("dplyr", lib.loc="~/R/win-library/3.5")
#################### Reliability  Metric for Storage ########################
#  -- Metrics based on WBWCD - Drought Contigency Plan Drought Levels --  #
# See Table 3-2 : Hot/Dry Projected Drought for Drought Levels

Shortage_Rel_Metrics <- data.frame(J1Data[,5])
#View(Stor_Metrics)

i=1
while (i<=(3240/3)) {
  Shortage_Rel_Metrics[i,] <- ifelse(J1Data[i,5]>0,1,0)
  i=i+1
}

## Calculate Reliability
Shortage_Rel <- data.frame(J1Data[,5])

i=1
while (i<=(3240/3)) {
  Shortage_Rel[(i:(i+89)),] <- rep(round(sum((Shortage_Rel_Metrics[(i:(i+89)),]/30)*100),1),30)
  i=i+30
}

p <- plot_ly(
  x = J1Data$Demand,
  y = J1Data$Inflows,
  z = Shortage_Rel$J1Data...5., type = "contour",
  #colors = c("red","orange","yellow","white"),
  #contours = list(coloring = 'heatmap',colors = c("red","orange","yellow","white")),
  autocontour = F,contours = list(
    start = 0,
    end = 12000,
    size = 2000 ) )%>%
  layout(title = "Annual Average Shortage Reliability Metric",
         xaxis = list(title ="Demand"),
         yaxis = list(title = "Inflows"))
p


##########################################################################################
#Without Sedimentation
##########################################################################################
Shortage_Rel_Metrics_NoSed <- data.frame(J1Data_NoSed$Shortage)
#View(Stor_Metrics)

i=1
while (i<=1080) {
  Shortage_Rel_Metrics_NoSed[i,] <- ifelse(J1Data_NoSed[i,5]>0,1,0)
  i=i+1
}

## Calculate Reliability
Shortage_Rel_NoSed <- data.frame(c(1:1080))

i=1
while (i<=1080) {
  Shortage_Rel_NoSed[(i:(i+29)),] <- rep(round(sum((Shortage_Rel_Metrics_NoSed[(i:(i+29)),]/30)*100),1),30)
  i=i+30
}

# 0 Percent Reservoir Volume
p <- plot_ly(
  x = J1Data_NoSed$Demand,
  y = J1Data_NoSed$Inflows,
  z = Shortage_Rel_NoSed$c.1.1080., type = "contour",
  #colors = c("red","orange","yellow","white"),
  #contours = list(coloring = 'heatmap',colors = c("red","orange","yellow","white")),
  autocontour = F,contours = list(start = 0,end = 15,size = 1 ) )%>%
  layout(title = "Shortage Reliability Metric",
         xaxis = list(title ="Demand"),
         yaxis = list(title = "Inflows"))
p


#10 Percent Reservoir Volume Lost
p <- plot_ly(
  x = J1Data_NoSed$Demand,
  y = J1Data_NoSed$Inflows,
  z = Shortage_Rel_NoSed$c.1.1080., type = "contour",
  #colors = c("red","orange","yellow","white"),
  #contours = list(coloring = 'heatmap',colors = c("red","orange","yellow","white")),
  autocontour = F,contours = list(
    start = 0,
    end = 10250,
    size = 250 ) )%>%
  layout(title = "Shortage Reliability Metric",
         xaxis = list(title ="Demand"),
         yaxis = list(title = "Inflows"))
p

#30% Reservoir Volume Lost
p <- plot_ly(
  x = J1Data_NoSed$Demand,
  y = J1Data_NoSed$Inflows,
  z = Shortage_Rel_NoSed$c.1.1080., type = "contour",
  #colors = c("red","orange","yellow","white"),
  #contours = list(coloring = 'heatmap',colors = c("red","orange","yellow","white")),
  autocontour = F,contours = list(
    start = 0,
    end = 100,
    size = 25 ) )%>%
  layout(title = "Shortage Reliability Metric",
         xaxis = list(title ="Demand"),
         yaxis = list(title = "Inflows"))
p

