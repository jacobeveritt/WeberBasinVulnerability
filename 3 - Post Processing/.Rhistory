#merge factors
tempfile <- merge(Stacked_Demand_Annual,Stacked_Inflow_Annual,by ="ID")
tempfile <- merge(tempfile,Stacked_Shortage_Annual,by = "ID")
#View(tempfile)
AllDataDF <- merge(tempfile,Stacked_Stor_Annual,by ="ID")
#Get rid of nonessential columns
AllAvgData <- data.frame(AllDataDF$Demand,AllDataDF$Inflows,AllDataDF$Storage,AllDataDF$Shortages,AllDataDF$Year)
#View(Data)
names(AllAvgData)[1] <- paste("Demand")
names(AllAvgData)[2] <- paste("Inflows")
names(AllAvgData)[3] <- paste("Storage")
names(AllAvgData)[4] <- paste("Shortages")
##################################################################################################
##PLOTS
##################################################################################################
library(plotly)
### Plot AllData Dataframe ##########
p <- plot_ly(AllAvgData,x =AllAvgData$Demand,y=AllAvgData$Inflows,color = AllAvgData$Storage)
for(trace in colnames(Data)){
p <- p %>% plotly::add_trace(y = as.formula(paste0("~`",trace,"`")),name = trace)
}
p
p <- plot_ly(AllAvgData,x =AllAvgData$Inflows,y=AllAvgData$Demand,color = AllAvgData$Storage)
for(trace in colnames(AllAvgData)){
p <- p %>% plotly::add_trace(y = as.formula(paste0("~`",trace,"`")),name = trace)
}
p
p <- plot_ly(AllAvgData,x =AllAvgData$Inflows,color = AllAvgData$Storage) %>%
layout(title = "Title",
xaxis = list(title ="Inflows"),
yaxis = list(title = "Demand (Acre-Feet)          Storage (Acre-Feet)"))
p
p <- plot_ly(AllAvgData,x =AllAvgData$Demand,color = AllAvgData$Storage)
for(trace in colnames(AllAvgData)){
p <- p %>% plotly::add_trace(y = as.formula(paste0("~`",trace,"`")),name = trace)
}
p
#################### Individual plots #####################################
#X = Demand, Y= Inflows
p <- plot_ly(AllAvgData,x =AllAvgData$Demand,y=AllAvgData$Inflows ,color = AllAvgData$Storage)%>%
layout(title = "TITLE",
xaxis = list(title ="Demand"),
yaxis = list(title = "Inflows"))
p
#X = Demand, Y= Inflows Z = Shortages
p <- plot_ly(AllAvgData,x =AllAvgData$Demand,y=AllAvgData$Inflows ,color = AllAvgData$Shortages)%>%   #How to ignore 0 values
layout(title = "Demand Factor to Inflow Factor",
xaxis = list(title ="Demand"),
yaxis = list(title = "Inflows"))
p
#X = Shortage, Y= Storage Z= Demands
p <- plot_ly(AllAvgData,x =AllAvgData$Shortage,y=AllAvgData$Storage ,color = AllAvgData$Demand) %>%
layout(title = "Title",
xaxis = list(title ="Shortage (Acre-Feet)"),
yaxis = list(title = "Storage (Acre-Feet)"))                        # look at removing 0 values of Shortages in plots
p
#X = Shortage, Y= Storage Z= Inflows
p <- plot_ly(AllAvgData,x =AllAvgData$Shortage,y=AllAvgData$Storage ,color = AllAvgData$Inflows)%>%
layout(title = "Title",
xaxis = list(title ="Shortage (Acre-Feet)"),
yaxis = list(title = "Storage (Acre-Feet)"))
p
#######plot storage data##---------------------------------------------------------------------------------
#Line plots
#Loop                   #Get rid of Alpha line??
#different Colors
library(plotly)
p<- plot_ly(Tot_Stor, x = Tot_Stor$Date, name = 'Base', type = 'scatter', mode = 'lines',
line = list(color = colors(distinct = F), width = 2)) %>%
layout(title = "Monthly Storage",
xaxis = list(title ="Time"),
yaxis = list(title = "Storage (Acre-Feet)"))
for(trace in colnames(Tot_Stor)){
p <- p %>% plotly::add_trace(y = as.formula(paste0("~`",trace,"`")),name = trace)
}
p
## Average Annual Storage ### By Water Year November to October
Tot_Stor_Avg_Annual <-1:30
Tot_Stor_Avg_Annual <- data.frame(Tot_Stor_Avg_Annual)
k=1
while (k<=36) {
i=1
j=12
while (i<=30) {
Tot_Stor_Avg_Annual[i,k] <- mean(na.omit(Tot_Stor[(j-11):j,k]))
i=i+1
j=j+12
}
k=k+1
}
#View(Tot_Stor_Avg_Annual)
#rename columns
i=1
TTNum <- 1
TNum <- 1
while (i<=Tot_TraceNum) {
TraceNum1 <- paste0("Trace",TNum)
TraceNum2<- paste0(",Trace",TTNum)
TraceDirectory <- paste0(TraceNum1,TraceNum2)
colnames(Tot_Stor_Avg_Annual)[i] <-  TraceDirectory
i=i+1
if(TTNum > (TraceNumber-1)){
TNum = TNum +1
} else {
TNum = TNum
}
if(TTNum > (TraceNumber1-1)){
TTNum = 1
} else {
TTNum = TTNum + 1
}
}
#add Date column
Tot_Stor_Avg_Annual$Year <- seq.Date(as.Date("0000/11/30"),by ="year",length=30)
#Multiline plot Average Annual Storage
#Line plot
#Loop                   #Get rid of Base line??
#different Colors
library(plotly)
p<- plot_ly(Tot_Stor_Avg_Annual, x = Tot_Stor_Avg_Annual$Year, name = 'Base', type = 'scatter', mode = 'lines',
line = list(color = colors(distinct = F), width = 2)) %>%
layout(title = "Average Annual Storage",
xaxis = list(title ="Time"),
yaxis = list(title = "Storage (Acre-Feet)"))
for(trace in colnames(Tot_Stor_Avg_Annual)){
p <- p %>% plotly::add_trace(y = as.formula(paste0("~`",trace,"`")),name = trace)
}
p
#Parallel plots
df <- Tot_Stor
Pp <-df %>%
plot_ly(type = 'parcoords', x=
dimensions = list(
list(range =c(1000,5000)),
label = 'Storage', values = Storage_Combined
)
)
#################### Reliability  Metric for Storage ########################
#  -- Metrics based on WBWCD - Drought Contigency Plan Drought Levels --  #
# See Table 3-2 : Hot/Dry Projected Drought for Drought Levels
# Moderate Total Basin Storage Drought Level 340K to 380K -- Yellow  ("Less than 380K")
# Severe Total Basin Storage Drought Level 280K to 340K -- Orange    ("Less than 340K")
# Extreme Total Basin Storage Drought Level less than 280K -- Red    ("Less than 280K")
ModerateLevel<- 380000
SevereLevel <- 340000
ExtremeLevel<-280000
Storage_Metrics <- data.frame(Tot_Stor)
Storage_Rel_Metrics_Moderate <- data.frame(Tot_Stor)
Storage_Rel_Metrics_Severe <- data.frame(Tot_Stor)
Storage_Rel_Metrics_Extreme <- data.frame(Tot_Stor)
#View(Stor_Metrics)
#Moderate
i=1
j=1
while (j<=108) {
while (i<=359) {
Storage_Rel_Metrics_Moderate[i,j] <- ifelse(Tot_Stor[i,j]>ModerateLevel,1,0)
i=i+1
}
i=1
j=j+1 # implement data after calculated to only looking at no change in sedimentation only Trace1 0% change in reservoir storage
}
#Severe
i=1
j=1
while (j<=108) {
while (i<=359) {
Storage_Rel_Metrics_Severe[i,j] <- ifelse(Tot_Stor[i,j]>SevereLevel,1,0)
i=i+1
}
i=1
j=j+1 # implement data after calculated to only looking at no change in sedimentation only Trace1 0% change in reservoir storage
}
#Extreme
i=1
j=1
while (j<=108) {
while (i<=359) {
Storage_Rel_Metrics_Extreme[i,j] <- ifelse(Tot_Stor[i,j]>ExtremeLevel,1,0)
i=i+1
}
i=1
j=j+1 # implement data after calculated to only looking at no change in sedimentation only Trace1 0% change in reservoir storage
}
#View(Storage_Rel_Metrics_Moderate)
#View(Storage_Rel_Metrics_Severe)
#View(Storage_Rel_Metrics_Extreme)
## Calculate Reliability
Stor_Rel_Moderate <- data.frame(Storage_Rel_Metrics_Moderate[1,])
Stor_Rel_Severe <- data.frame(Storage_Rel_Metrics_Severe[1,])
Stor_Rel_Extreme <- data.frame(Storage_Rel_Metrics_Extreme[1,])
i=1
while (i<=108) {
Stor_Rel_Moderate[,i] <- round(sum((Storage_Rel_Metrics_Moderate[,i]/359)*100),1)
i=i+1
}
SRM<- Stor_Rel_Moderate
x<-data.frame(colnames(Stor_Rel_Moderate))
i=1
while (i<=108) {
Stor_Rel_Severe[,i] <- round(sum((Storage_Rel_Metrics_Severe[,i]/359)*100),1)
i=i+1
}
SRS<- Stor_Rel_Severe
i=1
while (i<=108) {
Stor_Rel_Extreme[,i] <- round(sum((Storage_Rel_Metrics_Extreme[,i]/359)*100),1)
i=i+1
}
SRE<- Stor_Rel_Extreme
#transpose data
Stor_Rel_Moderate <- data.frame(t(Stor_Rel_Moderate))
Stor_Rel_Severe <- data.frame(t(Stor_Rel_Severe))
Stor_Rel_Extreme <- data.frame(t(Stor_Rel_Extreme))
#Plot Reliability -- Storage
p <- plot_ly( data = Stor_Rel_Moderate,
x = x[1:108],
y = Stor_Rel_Moderate[1:108,],
type = 'scatter', mode = 'lines' #)%>%
#layout(title = "Storage Reliablity"
)
p
#Plot Reliability -- Storage -- No Sedimentation
library("data.table", lib.loc="~/R/win-library/3.5")
#Moderate
Stor_Rel_Moderate_NoSediment <- data.table(rep(0,36))
i=1
j=1
while (i<=36) {
Stor_Rel_Moderate_NoSediment[i,1] <- SRM[1,j]
i=i+1
j=j+3
}
#View(Stor_Rel_Moderate_NoSediment)
#Rename Row Names
i=1
for(TTTNum in 1:TraceNumber){
for(TTNum in 1:TraceNumber1){
TraceDirectory <- paste0(",Trace",TTNum)
TraceNum1<- paste0("Trace",TTTNum)
TraceDirectory <- paste0(TraceNum1,TraceDirectory)
rownames(Stor_Rel_Moderate_NoSediment)[i] <-  TraceDirectory
i=i+1
}
}
p <- plot_ly( data = Stor_Rel_Moderate_NoSediment,
x = rownames(Stor_Rel_Moderate_NoSediment),
y = Stor_Rel_Moderate_NoSediment$V1,
type = 'scatter', mode = 'lines' #)%>%
#layout(title = "Storage Reliablity"
)
p
#Severe
Stor_Rel_Severe_NoSediment <- data.table(rep(0,36))
i=1
j=1
while (i<=36) {
Stor_Rel_Severe_NoSediment[i,1] <- SRS[1,j]
i=i+1
j=j+3
}
#View(Stor_Rel_Severe_NoSediment)
p <- plot_ly( data = Stor_Rel_Severe_NoSediment,
x = rownames(Stor_Rel_Moderate_NoSediment),
y = Stor_Rel_Severe_NoSediment$V1,
type = 'scatter', mode = 'lines' #)%>%
#layout(title = "Storage Reliablity"
)
p
#Extreme
Stor_Rel_Extreme_NoSediment <- data.table(rep(0,36))
i=1
j=1
while (i<=36) {
Stor_Rel_Extreme_NoSediment[i,1] <- SRE[1,j]
i=i+1
j=j+3
}
#View(Stor_Rel_Extreme_NoSediment)
p <- plot_ly( data = Stor_Rel_Extreme_NoSediment,
x = rownames(Stor_Rel_Moderate_NoSediment),
y = Stor_Rel_Extreme_NoSediment$V1,
type = 'scatter', mode = 'lines' #)%>%
#layout(title = "Storage Reliablity"
)
p
## Plot All together
p <- plot_ly( data = Stor_Rel_Moderate_NoSediment,
x = rownames(Stor_Rel_Moderate_NoSediment),
y = Stor_Rel_Moderate_NoSediment$V1, name = 'Moderate Drought Level',
type = 'scatter', mode = 'lines',line = list(color = "yellow"))%>%
layout(title = "Storage Reliablity Levels Percentage"
) %>%
add_trace(y=Stor_Rel_Severe_NoSediment$V1,name = 'Severe Drought Level' ,mode='lines',line =list(color="orange")) %>%
add_trace(y=Stor_Rel_Extreme_NoSediment$V1,name = 'Extreme Drought Level',mode='lines',line=list(color = "red"))
p
#################### Reliability  Metric for Storage ########################
#  -- Metrics based on WBWCD - Drought Contigency Plan Drought Levels --  #
# See Table 3-2 : Hot/Dry Projected Drought for Drought Levels
# Moderate Total Basin Storage Drought Level 340K to 380K -- Yellow  ("Less than 380K")
# Severe Total Basin Storage Drought Level 280K to 340K -- Orange    ("Less than 340K")
# Extreme Total Basin Storage Drought Level less than 280K -- Red    ("Less than 280K")
ModerateLevel<- 380000
SevereLevel <- 340000
ExtremeLevel<-280000
Storage_Metrics <- data.frame(J1Data[,3])
Storage_Rel_Metrics_Moderate <- data.frame(J1Data[,3])
Storage_Rel_Metrics_Severe <- data.frame(J1Data[,3])
Storage_Rel_Metrics_Extreme <- data.frame(J1Data[,3])
#Moderate
i=1
while (i<=9720) {
Storage_Rel_Metrics_Moderate[i,] <- ifelse(J1Data[i,3]>ModerateLevel,1,0)
i=i+1
}
#Severe
i=1
while (i<=9720) {
Storage_Rel_Metrics_Severe[i,] <- ifelse(J1Data[i,3]>SevereLevel,1,0)
i=i+1
}
#Extreme
i=1
while (i<=9720) {
Storage_Rel_Metrics_Extreme[i,] <- ifelse(J1Data[i,3]>ExtremeLevel,1,0)
i=i+1
}
## Calculate Reliability
Stor_Rel_Moderate <- data.frame(J1Data[,3])
Stor_Rel_Severe <- data.frame(J1Data[,3])
Stor_Rel_Extreme <- data.frame(J1Data[,3])
i=1
while (i<=9720) {
Stor_Rel_Moderate[i,] <- round(sum((Storage_Rel_Metrics_Moderate[(i:i+29),]/30)*100),1)
i=i+30
}
View(Stor_Rel_Moderate)
i=1
while (i<=9720) {
Stor_Rel_Moderate[(i:i+29),] <- round(sum((Storage_Rel_Metrics_Moderate[(i:i+29),]/30)*100),1)
i=i+30
}
SRM<- Stor_Rel_Moderate
i=1
while (i<=9720) {
Stor_Rel_Moderate[(i:i+29),] <- round(sum((Storage_Rel_Metrics_Moderate[(i:i+29),]/30)*100),1)
i=i+30
}
## Calculate Reliability
Stor_Rel_Moderate <- data.frame(J1Data[,3])
Stor_Rel_Severe <- data.frame(J1Data[,3])
Stor_Rel_Extreme <- data.frame(J1Data[,3])
i=1
while (i<=9720) {
Stor_Rel_Moderate[(i:i+29),] <- rep(round(sum((Storage_Rel_Metrics_Moderate[(i:i+29),]/30)*100),1),30)
i=i+30
}
## Calculate Reliability
Stor_Rel_Moderate <- data.frame(J1Data[,3])
Stor_Rel_Severe <- data.frame(J1Data[,3])
Stor_Rel_Extreme <- data.frame(J1Data[,3])
i=1
while (i<=9720) {
Stor_Rel_Moderate[(i:(i+29)),] <- rep(round(sum((Storage_Rel_Metrics_Moderate[(i:(i+29)),]/30)*100),1),30)
i=i+30
}
p <- plot_ly(
x = J1Data$Demand,
y = J1Data$Inflows,
z = Stor_Rel_Moderate$J1Data...3., type = "contour")%>%
layout(title = "Storage by Color",
xaxis = list(title ="Demand"),
yaxis = list(title = "Inflows"))
p
i=1
while (i<=9720) {
Stor_Rel_Severe[(i:(i+29)),] <- rep(round(sum((Storage_Rel_Metrics_Severe[(i:(i+29)),]/30)*100),1),30)
i=i+30
}
i=1
while (i<=9720) {
Stor_Rel_Extreme[(i:(i+29)),] <- rep(round(sum((Storage_Rel_Metrics_Extreme[(i:(i+29)),]/30)*100),1),30)
i=i+30
}
p <- plot_ly(
x = J1Data$Demand,
y = J1Data$Inflows,
z = Stor_Rel_Severe$J1Data...3., type = "contour")%>%
layout(title = "Storage by Color",
xaxis = list(title ="Demand"),
yaxis = list(title = "Inflows"))
p
p <- plot_ly(
x = J1Data$Demand,
y = J1Data$Inflows,
z = Stor_Rel_Extreme$J1Data...3., type = "contour")%>%
layout(title = "Storage by Color",
xaxis = list(title ="Demand"),
yaxis = list(title = "Inflows"))
p
View(J1Data)
Storage_Metrics <- data.frame(J1Data[,4])
#Moderate
i=1
while (i<=9720) {
Storage_Rel_Metrics_Moderate[i,] <- ifelse(J1Data[i,4]>0,1,0)
i=i+1
}
Shortage_Metrics <- data.frame(J1Data[,4])
#Moderate
i=1
while (i<=9720) {
Shortage_Rel_Metrics[i,] <- ifelse(J1Data[i,4]>0,1,0)
i=i+1
}
Shortage_Rel_Metrics <- data.frame(J1Data[,4])
#Moderate
i=1
while (i<=9720) {
Shortage_Rel_Metrics[i,] <- ifelse(J1Data[i,4]>0,1,0)
i=i+1
}
## Calculate Reliability
Shortage_Rel <- data.frame(J1Data[,4])
i=1
while (i<=9720) {
Shortage_Rel[(i:(i+29)),] <- rep(round(sum((Shortage_Rel_Metrics[(i:(i+29)),]/30)*100),1),30)
i=i+30
}
# Moderate Demand Level
p <- plot_ly(
x = J1Data$Demand,
y = J1Data$Inflows,
z = Shortage_Rel$J1Data...4., type = "contour")%>%
layout(title = "Shortage Reliablity Metric",
xaxis = list(title ="Demand"),
yaxis = list(title = "Inflows"))
p
x = J1Data$Demand,
y = J1Data$Inflows,
z = Shortage_Rel$J1Data...4., type = "contour",
#colors = c("red","orange","yellow","white"),
#contours = list(coloring = 'heatmap',colors = c("red","orange","yellow","white")),
autocontour = F,contours = list(
start = 0,
end = 100,
size = 25  )%>%
layout(title = "Shortage Reliablity Metric",
xaxis = list(title ="Demand"),
yaxis = list(title = "Inflows"))
p <- plot_ly(
x = J1Data$Demand,
y = J1Data$Inflows,
z = Shortage_Rel$J1Data...4., type = "contour",
#colors = c("red","orange","yellow","white"),
#contours = list(coloring = 'heatmap',colors = c("red","orange","yellow","white")),
autocontour = F,contours = list(
start = 0,
end = 100,
size = 25 ) )%>%
layout(title = "Shortage Reliablity Metric",
xaxis = list(title ="Demand"),
yaxis = list(title = "Inflows"))
p
# Moderate Demand Level
p <- plot_ly(
x = J1Data$Demand,
y = J1Data$Inflows,
z = Stor_Rel_Moderate$J1Data...3., type = "contour",
#colors = c("red","orange","yellow","white"),
#contours = list(coloring = 'heatmap',colors = c("red","orange","yellow","white")),
autocontour = F,contours = list(
start = 0,
end = 100,
size = 25 ) )%>%
layout(title = "Moderate Storage Level by Color",
xaxis = list(title ="Demand"),
yaxis = list(title = "Inflows"))
p
#Severe Demand Level
p <- plot_ly(
x = J1Data$Demand,
y = J1Data$Inflows,
z = Stor_Rel_Severe$J1Data...3., type = "contour",
#colors = c("red","orange","yellow","white"),
#contours = list(coloring = 'heatmap',colors = c("red","orange","yellow","white")),
autocontour = F,contours = list(
start = 0,
end = 100,
size = 25 ) )%>%
layout(title = "Severe Storage by Level Color",
xaxis = list(title ="Demand"),
yaxis = list(title = "Inflows"))
p
#Extreme Demand Level
p <- plot_ly(
x = J1Data$Demand,
y = J1Data$Inflows,
z = Stor_Rel_Extreme$J1Data...3., type = "contour",
#colors = c("red","orange","yellow","white"),
#contours = list(coloring = 'heatmap',colors = c("red","orange","yellow","white")),
autocontour = F,contours = list(
start = 0,
end = 100,
size = 25 ) )%>%
layout(title = "Extreme Storage by Color",
xaxis = list(title ="Demand"),
yaxis = list(title = "Inflows"))
p
View(J1Data)
dplyr()
library("dplyr", lib.loc="~/R/win-library/3.5")
