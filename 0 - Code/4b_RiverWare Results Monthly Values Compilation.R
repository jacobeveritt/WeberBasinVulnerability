# *------------------------------------------------------------------
# | PROGRAM NAME: Data Compilation
# | FILE NAME: RiverWare Results Monthly Data Compilation
# | DATE: 01/25/20
# | CREATED BY:  Jacob Everitt
# *----------------------------------------------------------------
# | PURPOSE:  Compile Data into 1 data.frame and analyze
# |
# |
# |*------------------------------------------------------------------.
# | DATA USED:  Inputs and Outputs
# |   1 - RiverWare Inputs:
# |     A. - Demand
# |     B. - Inflow
# |     C. - Sedimentation
# | 
# |   2 - RiverWare Outputs
# |     A. - Storage
# |     B. - Shortage
# |
# |*------------------------------------------------------------------
# | CONTENTS: Compilation of data 
# |
# | 0 - Create a Trace notation that matches the output from RiverSmart
# |    a. First Trace is Demand
# |    b. 2nd Trace Notation is Inflow
# |    c. Last Trace Notation is Sedimentation
# | 1 - Create individual dataframes for each Input
# |    A. Demand  -- Tot_Demand
# |    B. Inflow  -- Tot_Inflow
# |    C. Sedimentation  -- Tot_Sed
# |
# | 2 - Create individual dataframes for each output
# |    A. Storage -- Tot_Stor
# |    B. Shortage -- Tot_Short
# |    C. 
# *-----------------------------------------------------------------
# | LIST UPDATES FROM ORIGINAL:
# |
# |
# *------------------------------------------------------------------

### Clear any existing data or functions.
rm(list=ls())
library("dplyr", lib.loc="~/R/win-library/3.5")

#Record the current directory (0 - Code) for later recall
startWD <- getwd()

###Total Storage Compilation#--------------------------------------------------------------------------------#
#Store the current code directory so we can later return to it (0 - Code)
### Load the package or install if not present
if (!require("RColorBrewer")) {
  install.packages("RColorBrewer")
  library(RColorBrewer)
}
library(readr)
#install.packages("reshape")
library(reshape) #For Melt
library(lubridate) #For month
library(plotly) # For Plots
library(data.table)
library(dplyr)

####-----------------------------Trace Notation--------------------------------------------------
# Build names of folders output by RiverSmart
TraceNumber <- 6
TraceNumber1 <-6
TraceNumber2 <-3
Tot_TraceNum <- TraceNumber*TraceNumber1*TraceNumber2

Trace_Notation <-c(1:Tot_TraceNum)
i=1
for(TTTNum in 1:TraceNumber){
  for(TTNum in 1:TraceNumber1){
    for(TNum in 1:TraceNumber2){
      TraceDirectory <- paste0(",Trace",TNum)
      TraceNum1<- paste0(",Trace",TTNum)
      TraceDirectory <- paste0(TraceNum1,TraceDirectory)
      TraceNum2 <- paste0("Trace",TTTNum)
      TraceDirectory <- paste0(TraceNum2,TraceDirectory)
      
      Trace_Notation[i] <-  TraceDirectory
      i=i+1
    }
  }
}

Trace_Notation_Data<- rep(Trace_Notation,359)

#View(Trace_Notation_Data)

##################################  - 1 - Input data ########################################################

  ######## - A -   Compiling Annual Demands  ########
setwd("~/GitHub/WeberBasinVulnerability/WeberBasinVulnerability/1 - Scenario Processing/Annual Service Area Demand Scenarios/Output")
#setwd("../1 - Scenario Processing/Annual Service Area Demand Scenarios/Output")


library(readxl)
DemandSelections <- read_excel("DemandSelections.xlsx")
#View(DemandSelections)

Tot_Annual_Demand <- read.csv("SumMIandAG.csv")
Tot_Annual_Demand[,2] <- DemandSelections$MI...AG
Tot_Annual_Demand
Tot_Demand <- data.frame(c(1:108))


i=1
j=1
while (i<=6) {
  Tot_Demand[j:(j+17),] <- rep(Tot_Annual_Demand[i,2],(18))  
  i=i+1
  j=j+18
}

#View(Tot_Demand)
colnames(Tot_Demand) <- "Demand"
rownames(Tot_Demand) <- Trace_Notation

#Tot_Demand <- data.frame(Tot_Demand)

Tot_Mnthly_Demand<-data.frame(rep(Tot_Demand$Demand,359))
colnames(Tot_Mnthly_Demand) <- "Demand"
#View(Tot_Monthly_Inflow)              

  ######### - B -  Monthly Inflows Data  ##########

# Switch into local directory
  setwd("~/GitHub/WeberBasinVulnerability/WeberBasinVulnerability/2 - RiverWare Modeling/Scenario")
#  setwd(startWD)
 # setwd("../2 - RiverWare Modeling/Scenario")

  
#Input Monthly data from RiverSmart Analysis
Tot_Mnthly_Inflow <-read.csv("Trace1,Trace1,Trace1/Total Inflows.csv")

i=1
for(TTTNum in 1:TraceNumber){
  for(TTNum in 1:TraceNumber1){
    for(TNum in 1:TraceNumber2){
      TraceDirectory <- paste0(",Trace",TNum)
      TraceDirectory <-paste0 (TraceDirectory,"/Total Inflows.csv")
      TraceNum1<- paste0(",Trace",TTNum)
      TraceDirectory <- paste0(TraceNum1,TraceDirectory)
      TraceNum2 <- paste0("Trace",TTTNum)
      TraceDirectory <- paste0(TraceNum2,TraceDirectory)
      
      Location <- TraceDirectory
      Temp_Storage <- read.csv(Location)
      Tot_Mnthly_Inflow[,i] <- Temp_Storage[,5]
      
      colnames(Tot_Mnthly_Inflow)[i] <-  TraceDirectory
      i=i+1
    }
  }
}

Tot_Mnthly_Inflow <- data.frame(Tot_Mnthly_Inflow)
#View(Tot_Mnthly_Inflow)

Months <- rep(c(1:12),31)
Months<- Months[(11:369)]
Tot_Mnthly_Inflow$Months <- Months

#Create Years
Years <- c(0:372)
i=1
j=1
while (j<=31) {
  Years[(i:(i+11))] <- rep((j-1),12)
  i=i+12
  j=j+1
}
Years<- Years[(11:369)]

#Add months and Years column
#Tot_Mnthly_Inflow$Months <-Months
Tot_Mnthly_Inflow$Years <- Years

#Add a Water year - The water year is designated by the calendar year in which it ends, so the 2010 water year (USGS) started on October 1, 2009 and ended on September 30, 2010
Tot_Mnthly_Inflow$WaterYear <- ifelse(Tot_Mnthly_Inflow$Months>= 10,Tot_Mnthly_Inflow$Years + 1, Tot_Mnthly_Inflow$Years)
WaterYear<-ifelse(Tot_Mnthly_Inflow$Months>= 10,Tot_Mnthly_Inflow$Years + 1, Tot_Mnthly_Inflow$Years)

#Transpose Data
Tot_Mnthly_Inflow_Transposed <- t(Tot_Mnthly_Inflow)
Tot_Mnthly_Inflow_Transposed <- data.frame(Tot_Mnthly_Inflow_Transposed)
    #View(Tot_Mnthly_Inflow_Transposed)
#Stack Columns
Tot_Mnthly_Inflow_Stacked <- stack(Tot_Mnthly_Inflow_Transposed[1:108,1:359])
Tot_Mnthly_Inflow <- Tot_Mnthly_Inflow_Stacked$values


#############################################   Monthly Weber @ Oakley Data   ####################################

#Input Monthly data from RiverSmart Analysis
Tot_Mnthly_Inflow_Oakley <-read.csv("Trace1,Trace1,Trace1/WeberatOaklely.csv")

i=1
for(TTTNum in 1:TraceNumber){
  for(TTNum in 1:TraceNumber1){
    for(TNum in 1:TraceNumber2){
      TraceDirectory <- paste0(",Trace",TNum)
      TraceDirectory <-paste0 (TraceDirectory,"/WeberatOaklely.csv")
      TraceNum1<- paste0(",Trace",TTNum)
      TraceDirectory <- paste0(TraceNum1,TraceDirectory)
      TraceNum2 <- paste0("Trace",TTTNum)
      TraceDirectory <- paste0(TraceNum2,TraceDirectory)
    
      Location <- TraceDirectory
      Temp_Storage <- read.csv(Location)
      Tot_Mnthly_Inflow_Oakley[,i] <- Temp_Storage[,5]
      
      colnames(Tot_Mnthly_Inflow_Oakley)[i] <-  TraceDirectory
      i=i+1
    }
  }
}

Tot_Mnthly_Inflow_Oakley <- data.frame(Tot_Mnthly_Inflow_Oakley)
#View(Tot_Mnthly_Inflow_Oakley)

Months <- rep(c(1:12),31)
Months<- Months[(11:369)]
Tot_Mnthly_Inflow_Oakley$Months <- Months

#Create Years
Years <- c(0:372)
i=1
j=1
while (j<=31) {
  Years[(i:(i+11))] <- rep((j-1),12)
  i=i+12
  j=j+1
}
Years<- Years[(11:369)]

#Add months and Years column
#Tot_Mnthly_Inflow_Oakley$Months <-Months
Tot_Mnthly_Inflow_Oakley$Years <- Years

#Add a Water year - The water year is designated by the calendar year in which it ends, so the 2010 water year (USGS) started on October 1, 2009 and ended on September 30, 2010
Tot_Mnthly_Inflow_Oakley$WaterYear <- ifelse(Tot_Mnthly_Inflow_Oakley$Months>= 10,Tot_Mnthly_Inflow_Oakley$Years + 1, Tot_Mnthly_Inflow_Oakley$Years)
WaterYear<-ifelse(Tot_Mnthly_Inflow_Oakley$Months>= 10,Tot_Mnthly_Inflow_Oakley$Years + 1, Tot_Mnthly_Inflow_Oakley$Years)

#Transpose Data
Tot_Mnthly_Inflow_Oakley_Transposed <- t(Tot_Mnthly_Inflow_Oakley)
Tot_Mnthly_Inflow_Oakley_Transposed <- data.frame(Tot_Mnthly_Inflow_Oakley_Transposed)
#View(Tot_Mnthly_Inflow_Oakley_Transposed)
#Stack Columns
Tot_Mnthly_Inflow_Oakley_Stacked <- stack(Tot_Mnthly_Inflow_Oakley_Transposed[1:108,1:359])
Tot_Mnthly_Inflow_Oakley.1 <- Tot_Mnthly_Inflow_Oakley_Stacked$values


#View(Tot_Mnthly_Inflow_Oakley)

Tot_Mnthly_Inflw_Okly<-Tot_Mnthly_Inflow_Oakley[,c(1,4,7,10,13,16)]

######## - C -   Compiling Total Sedimentation  ########

##Total Sedimentation Changes on Reservoir
  #Move back to code directory
  setwd(startWD)
  #Move into the local input directory
  #setwd("../3 - Post Processing")
  setwd("~/GitHub/WeberBasinVulnerability/WeberBasinVulnerability/3 - Post Processing")

Tot_Sed <- read.csv("Sedimentation.csv")
Tot_Sed <- Tot_Sed[,2]
Tot_Mnthly_Sed <- rep(Tot_Sed,359)

#### Time Columns: Mnths, Years and Water Years #####
Mnths<-c(1:38772)
i=1
j=1
while (i<=359) {
  Mnths[j:(i*108)]<-Months[i]    
i=i+1
j=j+108
  }
#View(Mnths)

Yrs<-c(1:38772)
i=1
j=1
while (i<=359) {
  Yrs[j:(i*108)]<-Years[i]    
  i=i+1
  j=j+108
}
#View(Yrs)

Wtr_Yrs<-c(1:38772)
i=1
j=1
while (i<=359) {
  Wtr_Yrs[j:(i*108)]<-WaterYear[i]    
  i=i+1
  j=j+108
}

##################   Compile Mnthly Input data    ##################################
#Create Data Frame
  Inputs<- data.frame(Tot_Mnthly_Demand)
  Inputs$Inflow <- Tot_Mnthly_Inflow
  Inputs$Sedimentation <- Tot_Mnthly_Sed
  Inputs$Trace_Notation <- Trace_Notation
  Inputs$Month<-Mnths
  Inputs$Years<-Yrs
  Inputs$WaterYear<-Wtr_Yrs
  Inputs$OakleyInflow <- Tot_Mnthly_Inflow_Oakley.1
  #Number
  Inputs$Number<-c(1:38772)
  Inputs <- data.frame(Inputs)

  
##################################  - 2 - Output data ########################################################
#Set Local Directory
  setwd(startWD)
  setwd("../2 - RiverWare Modeling/Scenario")
  setwd("~/GitHub/WeberBasinVulnerability/WeberBasinVulnerability/2 - RiverWare Modeling/Scenario")

Tot_Mnthly_Stor <- read.csv("Trace1,Trace1,Trace1/Total Storage_NO EVAP.csv")
Tot_Mnthly_Short <-read.csv("Trace1,Trace1,Trace1/Total Shortages.csv")

#Create TraceFolder Naming lookup for Values with No Evap.
#Move into the local input directory
#setwd("../2 - RiverWare Modeling/Scenario")
# Switch into local directory
#setwd("~/GitHub/WeberBasinVulnerability/WeberBasinVulnerability/2 - RiverWare Modeling/Scenario")

##### Total Storage #####
i=1
for(TTTNum in 1:TraceNumber){
  for(TTNum in 1:TraceNumber1){
    for(TNum in 1:TraceNumber2){
      TraceDirectory <- paste0(",Trace",TNum)
      TraceDirectory <-paste0 (TraceDirectory,"/Total Storage_NO EVAP.csv")
      TraceNum1<- paste0(",Trace",TTNum)
      TraceDirectory <- paste0(TraceNum1,TraceDirectory)
      TraceNum2 <- paste0("Trace",TTTNum)
      TraceDirectory <- paste0(TraceNum2,TraceDirectory)
      
      Location <- TraceDirectory
      Temp_Storage <- read.csv(Location)
      Tot_Mnthly_Stor[,i] <- Temp_Storage[,5]
      
      colnames(Tot_Mnthly_Stor)[i] <-  TraceDirectory
      i=i+1
    }
  }
}
Tot_Mnthly_Stor <- data.frame(Tot_Mnthly_Stor)

#Transpose Data
Tot_Mnthly_Stor_Transposed <- t(Tot_Mnthly_Stor)
Tot_Mnthly_Stor_Transposed <- data.frame(Tot_Mnthly_Stor_Transposed)
#View(Tot_Mnthly_Inflow_Transposed)
#Stack Columns
Tot_Mnthly_Stor_Stacked <- stack(Tot_Mnthly_Stor_Transposed[1:108,1:359])
Tot_Mnthly_Stor <- Tot_Mnthly_Stor_Stacked$values
Tot_Mnthly_Stor <- data.frame(Tot_Mnthly_Stor)

##### Total Shortages #####
i=1
for(TTTNum in 1:TraceNumber){
  for(TTNum in 1:TraceNumber1){
    for(TNum in 1:TraceNumber2){
      TraceDirectory <- paste0(",Trace",TNum)
      TraceDirectory <-paste0 (TraceDirectory,"/Total Shortages.csv")
      TraceNum1<- paste0(",Trace",TTNum)
      TraceDirectory <- paste0(TraceNum1,TraceDirectory)
      TraceNum2 <- paste0("Trace",TTTNum)
      TraceDirectory <- paste0(TraceNum2,TraceDirectory)
      Location <- TraceDirectory
      Temp_Storage <- read.csv(Location)
      Tot_Mnthly_Short[,i] <- Temp_Storage[,5]
      colnames(Tot_Mnthly_Short)[i] <-  TraceDirectory
      i=i+1
    }
  }
}
Tot_Mnthly_Short <- data.frame(Tot_Mnthly_Short)

#Transpose Data
Tot_Mnthly_Short_Transposed <- t(Tot_Mnthly_Short)
Tot_Mnthly_Short_Transposed <- data.frame(Tot_Mnthly_Short_Transposed)
#View(Tot_Mnthly_Inflow_Transposed)
#Stack Columns
Tot_Mnthly_Short_Stacked <- stack(Tot_Mnthly_Short_Transposed[1:108,1:359])
Tot_Mnthly_Short <- Tot_Mnthly_Short_Stacked$values
#Tot_Mnthly_Short <- data.frame(Tot_Mnthly_Short)


########################   Compile Output data   ###############################
Outputs <- Tot_Mnthly_Stor
Outputs$Shortage <- Tot_Mnthly_Short

# Add Trace Notation
#Outputs$Trace_Notation <-Trace_Notation
#Number
Outputs$Number<-c(1:38772)
Outputs<-data.frame(Outputs)

#########################  Merge  ---- Data Dataframe########################
Data <- merge(Inputs,Outputs,by="Number")  
#Data_Monthly <- Data

#########################################################################################################
                      ####### Calculate Annual Inflows -- Calculate Average by Trace#######
#########################################################################################################

#From Monthly Streamflows to Annual Streamflows
Monthly_Inflows_NO_Sed <- filter(Inputs,Sedimentation==0)
Monthly_Inflows<-distinct(Monthly_Inflows_NO_Sed,Inflow,Trace_Notation,WaterYear,Month)

Annual_Inflows <-Monthly_Inflows %>% 
group_by(WaterYear,Trace_Notation) %>% 
summarise_all(funs(sum(Inflow)))

#add Inflow name column
Annual_Inflows$Scenario <-rep(c('Hot Dry Flows','Base Flows (1940-1970)','Duration & Intensity Droughts (1930-1960)','Duration Droughts (1610-1640)','Intensity Drought (1520-1550)','Intensity Drought (1570-1600)'),180)
Annual_Inflows<-Annual_Inflows[,c(1:3,5)]

#Calculate Mean of Average Annual Inflows
Mean_of_Annual_Inflows <-Annual_Inflows %>% 
  group_by(Trace_Notation) %>% 
  summarise_all(funs(mean(Inflow)))

Mean_of_Annual_Inflows<-Mean_of_Annual_Inflows[,c(1,3)]
Mean_of_Annual_Inflows<-distinct(Mean_of_Annual_Inflows,Inflow)
Mean_of_Annual_Inflows$Scenario<-(c('Hot Dry Flows','Historic Flows (1940-1970)','Duration & Intensity Droughts (1930-1960)','Duration Droughts (1610-1640)','Intensity Drought (1520-1550)','Intensity Drought (1570-1600)'))
#View(Mean_of_Annual_Inflows)

#####Get rid of Excess Scenarios ######

Annual_Inflows<-distinct(Annual_Inflows,WaterYear,Inflow)
Annual_Inflows$Scenario<-rep(c('Hot Dry Flows','Historic Flows (1940-1970)','Duration & Intensity Droughts (1930-1960)','Duration Droughts (1610-1640)','Intensity Drought (1520-1550)','Intensity Drought (1570-1600)'),30)
Annual_Inflows$ScenarioNotation<-rep(c('-- Hot Dry Flows','-- Historic Flows (1940-1970)','-- Duration & Intensity Droughts (1930-1960)','-- Duration Droughts (1610-1640)','-- Intensity Drought (1520-1550)','-- Intensity Drought (1570-1600)'),30)

Annual_Inflows$MeanInflow<-full_join(Annual_Inflows,Mean_of_Annual_Inflows,by='Scenario')


##########################Plots for Presentation ###################
# Create color pallette
myblues<- c("lightblue","skyblue2","dodgerblue","dodgerblue4","blue2","navy")

#########  Plot Single Line  ##########
plot_ly(type='scatter',mode='text',text=Annual_Inflows$ScenarioNotation,
        x=c(rep(30,180)),y=Annual_Inflows$MeanInflow$Inflow.y,
        textposition='right', showlegend=F,colors=myblues)%>%
  add_trace(Annual_Inflows,y=Annual_Inflows$Inflow,x=Annual_Inflows$WaterYear,
            type = 'scatter',mode='lines',
            color = Annual_Inflows$Scenario,showlegend=T)%>%
    layout(title='District Total - Annual Average Inflows',xaxis=list(title='Water Year')
         ,yaxis = list(title='Inflow (Acre-Feet)'))

##Parallel plot                  ##################  Not complete
#plot_ly(data=Data,width = 900, height = 600) %>%
  add_trace(type = 'parcoords',
            line = list(color = Data$MI...AG,
                        colorscale = myblues,
                        showscale = TRUE,
                        reversescale = TRUE,
                        cmin = 35000,
                        cmax = 150000),
            dimensions = list(
              list(range = c(~round(min(Data$MI...AG)),~round(max(Data$MI...AG))),
                   # constraintrange = c(100000,150000),
                   label = 'Demand (AF/Yr)', values = round(Data$MI...AG)),
              list(range = c((~min(Data$Population)-1000),(~max(Data$Population)+1000)),
                   label = 'Population', values = Data$Population),
              list(range = c(~min(Data$AG_ConversionFactor),~max(Data$AG_ConversionFactor)),
                   label = 'Ag Conversion', values = Data$AG_ConversionFactor),
              list(range = c(~min(Data$Average_GPCD),~max(Data$Average_GPCD)),
                   label = 'Average GPCD', values = Data$Average_GPCD),
              list(range = c(~min(Data$ET_Changes),~max(Data$ET_Changes)),
                   label = 'ET Impact (AF/Yr)', values = Data$ET_Changes)  #,
              #list(range = c(~min(Data$Secondary_PerCapita_._Change),~max(Data$Secondary_PerCapita_._Change)),
              #    label = 'Average Secondary PerCapita % Change', values = Data$Secondary_PerCapita_._Change)
            )  )%>%
  layout(yaxis = list(title ='M&I + AG Demand (acre-feet)'),
         xaxis=list(title='FACTORS'))

#########################################################################################################
####### Calculate Annual Inflows -- Calculate Average by Trace#######  Weber River at Oakley
#########################################################################################################

#From Monthly Streamflows to Annual Streamflows Weber River at Oakley
Monthly_Inflows_NO_Sed <- filter(Inputs,Sedimentation==0)
Monthly_Inflows<-distinct(Monthly_Inflows_NO_Sed,OakleyInflow,Trace_Notation,WaterYear,Month)

Annual_Inflows <-Monthly_Inflows %>% 
  group_by(WaterYear,Trace_Notation) %>% 
  summarise_all(funs(sum(OakleyInflow)))

#add Inflow name column
Annual_Inflows$Scenario <-rep(c('Hot Dry Flows','Base Flows (1940-1970)','Duration & Intensity Droughts (1930-1960)','Duration Droughts (1610-1640)','Intensity Drought (1520-1550)','Intensity Drought (1570-1600)'),180)
Annual_Inflows<-Annual_Inflows[,c(1,2,4,5)]

#Calculate Mean of Average Annual Inflows Weber River at Oakley
Mean_of_Annual_Inflows <-Annual_Inflows %>% 
  group_by(Trace_Notation) %>% 
  summarise_all(funs(mean(OakleyInflow)))

Mean_of_Annual_Inflows<-Mean_of_Annual_Inflows[,c(1,3)]
Mean_of_Annual_Inflows<-distinct(Mean_of_Annual_Inflows,OakleyInflow)
Mean_of_Annual_Inflows$Scenario<-(c('Hot Dry Flows','Historic Flows (1940-1970)','Duration & Intensity Droughts (1930-1960)','Duration Droughts (1610-1640)','Intensity Drought (1520-1550)','Intensity Drought (1570-1600)'))
#View(Mean_of_Annual_Inflows)

#####Get rid of Excess Scenarios ###### Weber River at Oakley

Annual_Inflows<-distinct(Annual_Inflows,WaterYear,OakleyInflow)
Annual_Inflows$Scenario<-rep(c('Hot Dry Flows','Historic Flows (1940-1970)','Duration & Intensity Droughts (1930-1960)','Duration Droughts (1610-1640)','Intensity Drought (1520-1550)','Intensity Drought (1570-1600)'),30)
Annual_Inflows$ScenarioNotation<-rep(c('-- Hot Dry Flows','-- Historic Flows (1940-1970)','-- Duration & Intensity Droughts (1930-1960)','-- Duration Droughts (1610-1640)','-- Intensity Drought (1520-1550)','-- Intensity Drought (1570-1600)'),30)

Annual_Inflows$MeanInflow<-full_join(Annual_Inflows,Mean_of_Annual_Inflows,by='Scenario')


##########################Plots for Presentation ################### Weber River at Oakley
# Create color pallette
myblues<- c("lightblue","skyblue2","dodgerblue","dodgerblue4","blue2","navy")

#########  Plot Single Line  ##########
plot_ly(type='scatter',mode='text',text=Annual_Inflows$ScenarioNotation,
        x=c(rep(30,180)),y=Annual_Inflows$MeanInflow$OakleyInflow.y,
        textposition='right', showlegend=F,colors=myblues)%>%
  add_trace(Annual_Inflows,y=Annual_Inflows$OakleyInflow,x=Annual_Inflows$WaterYear,
            type = 'scatter',mode='lines',
            color = Annual_Inflows$Scenario,showlegend=T)%>%
  layout(title='Weber at Oakley - Annual Average Inflows',xaxis=list(title='Water Year')
         ,yaxis = list(title='Inflow (Acre-Feet)'))

#Finding Annual average for each trace

SmpAnnual_Inflows<-Annual_Inflows[1:3]

SmpAnnual_Inflows$TraceNum<-rep(c(1:6),30)

SeperateAnnual_Inflows1<-data.frame(c(1:30))
SeperateAnnual_Inflows2<-data.frame(c(1:30))
SeperateAnnual_Inflows3<-data.frame(c(1:30))
SeperateAnnual_Inflows4<-data.frame(c(1:30))
SeperateAnnual_Inflows5<-data.frame(c(1:30))
SeperateAnnual_Inflows6<-data.frame(c(1:30))

#FilterTraces - by Trace
SeperateAnnual_Inflows1<-filter(SmpAnnual_Inflows,TraceNum==1)
SeperateAnnual_Inflows2<-filter(SmpAnnual_Inflows,TraceNum==2)
SeperateAnnual_Inflows3<-filter(SmpAnnual_Inflows,TraceNum==3)
SeperateAnnual_Inflows4<-filter(SmpAnnual_Inflows,TraceNum==4)
SeperateAnnual_Inflows5<-filter(SmpAnnual_Inflows,TraceNum==5)
SeperateAnnual_Inflows6<-filter(SmpAnnual_Inflows,TraceNum==6)


#Round data
SeperateAnnual_Inflows1$OakleyInflow<-round(SeperateAnnual_Inflows1$OakleyInflow,digits = -3)
SeperateAnnual_Inflows2$OakleyInflow<-round(SeperateAnnual_Inflows2$OakleyInflow,digits = -3)
SeperateAnnual_Inflows3$OakleyInflow<-round(SeperateAnnual_Inflows3$OakleyInflow,digits = -3)
SeperateAnnual_Inflows4$OakleyInflow<-round(SeperateAnnual_Inflows4$OakleyInflow,digits = -3)
SeperateAnnual_Inflows5$OakleyInflow<-round(SeperateAnnual_Inflows5$OakleyInflow,digits = -3)
SeperateAnnual_Inflows6$OakleyInflow<-round(SeperateAnnual_Inflows6$OakleyInflow,digits = -3)

##Parallel plot                  ##################  Not complete
plot_ly(data=Data1,width = 900, height = 600) %>%
  add_trace(type = 'parcoords',
            line = list(color = SeperateAnnual_Inflows1$OakleyInflow,
                        colorscale = blues9,
                        showscale = F,
                        reversescale = TRUE,
                        cmin = 35000,
                        cmax = 150000),
            dimensions = list(
              list(range = c(~round(min(SeperateAnnual_Inflows1$OakleyInflow),digits = 0),round(max(SeperateAnnual_Inflows1$OakleyInflow))),
                   # constraintrange = c(100000,150000),
                   label = 'Hot Dry Flows', values = (SeperateAnnual_Inflows1$OakleyInflow)),
              list(range = c((~round(min(SeperateAnnual_Inflows2$OakleyInflow))-1),(~round(max(SeperateAnnual_Inflows2$OakleyInflow)))),
                   label = '(1940-1970)', values = SeperateAnnual_Inflows1$OakleyInflow),
              list(range = c(~round(min(SeperateAnnual_Inflows3$OakleyInflow)),~round(max(SeperateAnnual_Inflows3$OakleyInflow))),
                   label = '(1930-1960)', values = SeperateAnnual_Inflows3$OakleyInflow),
              list(range = c(~round(min(SeperateAnnual_Inflows4$OakleyInflow)),~round(max(SeperateAnnual_Inflows4$OakleyInflow))),
                   label = '(1610-1640)', values = SeperateAnnual_Inflows4$OakleyInflow),
              list(range = c(~round(min(SeperateAnnual_Inflows5$OakleyInflow)),~round(max(SeperateAnnual_Inflows5$OakleyInflow))),
                   label = '(1520-1550)', values = SeperateAnnual_Inflows5$OakleyInflow) ,
              list(range = c(~round(min(SeperateAnnual_Inflows6$OakleyInflow)),~round(max(SeperateAnnual_Inflows6$OakleyInflow))),
                  label = '(1570-1600)', values = SeperateAnnual_Inflows6$OakleyInflow)
            )  )%>%
  layout(yaxis = list(title ='Weber at Oakley - Annual Average Inflows'),
         xaxis=list(title='Traces'))


#FilterTraces - By Water Year   Won't use this plot not very informative
     #30 Years
SeperateAnnual_Inflows1<-data.frame(c(1:30))
SeperateAnnual_Inflows2<-data.frame(c(1:30))
SeperateAnnual_Inflows3<-data.frame(c(1:30))
SeperateAnnual_Inflows4<-data.frame(c(1:30))
SeperateAnnual_Inflows5<-data.frame(c(1:30))
SeperateAnnual_Inflows6<-data.frame(c(1:30))
SeperateAnnual_Inflows7<-data.frame(c(1:30))
SeperateAnnual_Inflows8<-data.frame(c(1:30))
SeperateAnnual_Inflows9<-data.frame(c(1:30))
SeperateAnnual_Inflows10<-data.frame(c(1:30))
SeperateAnnual_Inflows11<-data.frame(c(1:30))
SeperateAnnual_Inflows12<-data.frame(c(1:30))
SeperateAnnual_Inflows13<-data.frame(c(1:30))
SeperateAnnual_Inflows14<-data.frame(c(1:30))
SeperateAnnual_Inflows15<-data.frame(c(1:30))
SeperateAnnual_Inflows16<-data.frame(c(1:30))
SeperateAnnual_Inflows17<-data.frame(c(1:30))
SeperateAnnual_Inflows18<-data.frame(c(1:30))
SeperateAnnual_Inflows19<-data.frame(c(1:30))
SeperateAnnual_Inflows20<-data.frame(c(1:30))
SeperateAnnual_Inflows21<-data.frame(c(1:30))
SeperateAnnual_Inflows22<-data.frame(c(1:30))
SeperateAnnual_Inflows23<-data.frame(c(1:30))
SeperateAnnual_Inflows24<-data.frame(c(1:30))
SeperateAnnual_Inflows25<-data.frame(c(1:30))
SeperateAnnual_Inflows26<-data.frame(c(1:30))
SeperateAnnual_Inflows27<-data.frame(c(1:30))
SeperateAnnual_Inflows28<-data.frame(c(1:30))
SeperateAnnual_Inflows29<-data.frame(c(1:30))
SeperateAnnual_Inflows30<-data.frame(c(1:30))

  #Filter
SeperateAnnual_Inflows1<-filter(SmpAnnual_Inflows,WaterYear==1)
SeperateAnnual_Inflows2<-filter(SmpAnnual_Inflows,WaterYear==2)
SeperateAnnual_Inflows3<-filter(SmpAnnual_Inflows,WaterYear==3)
SeperateAnnual_Inflows4<-filter(SmpAnnual_Inflows,WaterYear==4)
SeperateAnnual_Inflows5<-filter(SmpAnnual_Inflows,WaterYear==5)
SeperateAnnual_Inflows6<-filter(SmpAnnual_Inflows,WaterYear==6)
SeperateAnnual_Inflows7<-filter(SmpAnnual_Inflows,WaterYear==7)
SeperateAnnual_Inflows8<-filter(SmpAnnual_Inflows,WaterYear==8)
SeperateAnnual_Inflows9<-filter(SmpAnnual_Inflows,WaterYear==9)
SeperateAnnual_Inflows10<-filter(SmpAnnual_Inflows,WaterYear==10)
SeperateAnnual_Inflows11<-filter(SmpAnnual_Inflows,WaterYear==11)
SeperateAnnual_Inflows12<-filter(SmpAnnual_Inflows,WaterYear==12)
SeperateAnnual_Inflows13<-filter(SmpAnnual_Inflows,WaterYear==13)
SeperateAnnual_Inflows14<-filter(SmpAnnual_Inflows,WaterYear==14)
SeperateAnnual_Inflows15<-filter(SmpAnnual_Inflows,WaterYear==15)
SeperateAnnual_Inflows16<-filter(SmpAnnual_Inflows,WaterYear==16)
SeperateAnnual_Inflows17<-filter(SmpAnnual_Inflows,WaterYear==17)
SeperateAnnual_Inflows18<-filter(SmpAnnual_Inflows,WaterYear==18)
SeperateAnnual_Inflows19<-filter(SmpAnnual_Inflows,WaterYear==19)
SeperateAnnual_Inflows20<-filter(SmpAnnual_Inflows,WaterYear==20)
SeperateAnnual_Inflows21<-filter(SmpAnnual_Inflows,WaterYear==21)
SeperateAnnual_Inflows22<-filter(SmpAnnual_Inflows,WaterYear==22)
SeperateAnnual_Inflows23<-filter(SmpAnnual_Inflows,WaterYear==23)
SeperateAnnual_Inflows24<-filter(SmpAnnual_Inflows,WaterYear==24)
SeperateAnnual_Inflows25<-filter(SmpAnnual_Inflows,WaterYear==25)
SeperateAnnual_Inflows26<-filter(SmpAnnual_Inflows,WaterYear==26)
SeperateAnnual_Inflows27<-filter(SmpAnnual_Inflows,WaterYear==27)
SeperateAnnual_Inflows28<-filter(SmpAnnual_Inflows,WaterYear==28)
SeperateAnnual_Inflows29<-filter(SmpAnnual_Inflows,WaterYear==29)
SeperateAnnual_Inflows30<-filter(SmpAnnual_Inflows,WaterYear==30)

#i=1
#while (i<=30) {
 # paste0("SeperateAnnual_Inflows",i)<-filter(SmpAnnual_Inflows,WaterYear==i)
#  i=i+1
#}


##Parallel plot                  ##################  Not complete
pp<-plot_ly(data=Data1,width = 900, height = 600) %>%
  add_trace(type = 'parcoords',
            line = list(color = SeperateAnnual_Inflows1$OakleyInflow,
                        colorscale = myblues,
                        showscale = TRUE,
                        reversescale = TRUE,
                        cmin = 35000,
                        cmax = 150000),
            dimensions = list(
              list(range = c(~round(min(SeperateAnnual_Inflows1$OakleyInflow)),~round(max(SeperateAnnual_Inflows1$OakleyInflow))),
                   # constraintrange = c(100000,150000),
                   label = 'Year 1', values = round(SeperateAnnual_Inflows1$OakleyInflow)),
              list(range = c((~min(SeperateAnnual_Inflows2$OakleyInflow)),(~max(SeperateAnnual_Inflows2$OakleyInflow)+1000)),
                   label = 'Year 2', values = SeperateAnnual_Inflows2$OakleyInflow),
              list(range = c(~min(SeperateAnnual_Inflows3$OakleyInflow),~max(SeperateAnnual_Inflows3$OakleyInflow)),
                   label = 'Year 3', values = SeperateAnnual_Inflows3$OakleyInflow),
              list(range = c(~min(SeperateAnnual_Inflows4$OakleyInflow),~max(SeperateAnnual_Inflows4$OakleyInflow)),
                   label = 'Year 4', values = SeperateAnnual_Inflows4$OakleyInflow),
              list(range = c(~min(SeperateAnnual_Inflows5$OakleyInflow),~max(SeperateAnnual_Inflows5$OakleyInflow)),
                   label = 'Year 5', values = SeperateAnnual_Inflows5$OakleyInflow) ,
              list(range = c(~min(SeperateAnnual_Inflows6$OakleyInflow),~max(SeperateAnnual_Inflows6$OakleyInflow)),
                   label = 'Year 6', values = SeperateAnnual_Inflows6$OakleyInflow),
              list(range = c((~min(SeperateAnnual_Inflows7$OakleyInflow)),(~max(SeperateAnnual_Inflows7$OakleyInflow)+1000)),
                   label = 'Year 7', values = SeperateAnnual_Inflows7$OakleyInflow),
              list(range = c((~min(SeperateAnnual_Inflows8$OakleyInflow)),(~max(SeperateAnnual_Inflows8$OakleyInflow)+1000)),
                   label = 'Year 8', values = SeperateAnnual_Inflows8$OakleyInflow),
              list(range = c((~min(SeperateAnnual_Inflows9$OakleyInflow)),(~max(SeperateAnnual_Inflows9$OakleyInflow)+1000)),
                   label = 'Year 9', values = SeperateAnnual_Inflows9$OakleyInflow),
              list(range = c((~min(SeperateAnnual_Inflows10$OakleyInflow)),(~max(SeperateAnnual_Inflows10$OakleyInflow)+1000)),
                   label = 'Year 10', values = SeperateAnnual_Inflows10$OakleyInflow),
              list(range = c((~min(SeperateAnnual_Inflows11$OakleyInflow)),(~max(SeperateAnnual_Inflows11$OakleyInflow)+1000)),
                   label = 'Year 11', values = SeperateAnnual_Inflows11$OakleyInflow),
              list(range = c((~min(SeperateAnnual_Inflows12$OakleyInflow)),(~max(SeperateAnnual_Inflows12$OakleyInflow)+1000)),
                   label = 'Year 12', values = SeperateAnnual_Inflows12$OakleyInflow),
              list(range = c((~min(SeperateAnnual_Inflows13$OakleyInflow)),(~max(SeperateAnnual_Inflows13$OakleyInflow)+1000)),
                   label = 'Year 13', values = SeperateAnnual_Inflows13$OakleyInflow),
              list(range = c((~min(SeperateAnnual_Inflows14$OakleyInflow)),(~max(SeperateAnnual_Inflows14$OakleyInflow)+1000)),
                   label = 'Year 14', values = SeperateAnnual_Inflows14$OakleyInflow),
              list(range = c((~min(SeperateAnnual_Inflows15$OakleyInflow)),(~max(SeperateAnnual_Inflows15$OakleyInflow)+1000)),
                   label = 'Year 15', values = SeperateAnnual_Inflows15$OakleyInflow),
              list(range = c((~min(SeperateAnnual_Inflows16$OakleyInflow)),(~max(SeperateAnnual_Inflows16$OakleyInflow)+1000)),
                   label = 'Year 16', values = SeperateAnnual_Inflows16$OakleyInflow),
              list(range = c((~min(SeperateAnnual_Inflows17$OakleyInflow)),(~max(SeperateAnnual_Inflows17$OakleyInflow)+1000)),
                   label = 'Year 17', values = SeperateAnnual_Inflows17$OakleyInflow),
              list(range = c((~min(SeperateAnnual_Inflows18$OakleyInflow)),(~max(SeperateAnnual_Inflows18$OakleyInflow)+1000)),
                   label = 'Year 18', values = SeperateAnnual_Inflows18$OakleyInflow),
              list(range = c((~min(SeperateAnnual_Inflows19$OakleyInflow)),(~max(SeperateAnnual_Inflows19$OakleyInflow)+1000)),
                   label = 'Year 19', values = SeperateAnnual_Inflows19$OakleyInflow),
              list(range = c((~min(SeperateAnnual_Inflows20$OakleyInflow)),(~max(SeperateAnnual_Inflows20$OakleyInflow)+1000)),
                   label = 'Year 20', values = SeperateAnnual_Inflows20$OakleyInflow),
              list(range = c((~min(SeperateAnnual_Inflows21$OakleyInflow)),(~max(SeperateAnnual_Inflows21$OakleyInflow)+1000)),
                   label = 'Year 21', values = SeperateAnnual_Inflows21$OakleyInflow),
              list(range = c((~min(SeperateAnnual_Inflows22$OakleyInflow)),(~max(SeperateAnnual_Inflows22$OakleyInflow)+1000)),
                   label = 'Year 22', values = SeperateAnnual_Inflows22$OakleyInflow),
              list(range = c((~min(SeperateAnnual_Inflows23$OakleyInflow)),(~max(SeperateAnnual_Inflows23$OakleyInflow)+1000)),
                   label = 'Year 23', values = SeperateAnnual_Inflows23$OakleyInflow),
              list(range = c((~min(SeperateAnnual_Inflows24$OakleyInflow)),(~max(SeperateAnnual_Inflows24$OakleyInflow)+1000)),
                   label = 'Year 24', values = SeperateAnnual_Inflows24$OakleyInflow),
              list(range = c((~min(SeperateAnnual_Inflows25$OakleyInflow)),(~max(SeperateAnnual_Inflows25$OakleyInflow)+1000)),
                   label = 'Year 25', values = SeperateAnnual_Inflows25$OakleyInflow),
              list(range = c((~min(SeperateAnnual_Inflows26$OakleyInflow)),(~max(SeperateAnnual_Inflows26$OakleyInflow)+1000)),
                   label = 'Year 26', values = SeperateAnnual_Inflows26$OakleyInflow),
              list(range = c((~min(SeperateAnnual_Inflows27$OakleyInflow)),(~max(SeperateAnnual_Inflows27$OakleyInflow)+1000)),
                   label = 'Year 27', values = SeperateAnnual_Inflows27$OakleyInflow),
              list(range = c((~min(SeperateAnnual_Inflows28$OakleyInflow)),(~max(SeperateAnnual_Inflows28$OakleyInflow)+1000)),
                   label = 'Year 28', values = SeperateAnnual_Inflows28$OakleyInflow),
              list(range = c((~min(SeperateAnnual_Inflows29$OakleyInflow)),(~max(SeperateAnnual_Inflows29$OakleyInflow)+1000)),
                   label = 'Year 29', values = SeperateAnnual_Inflows29$OakleyInflow),
              list(range = c((~min(SeperateAnnual_Inflows30$OakleyInflow)),(~max(SeperateAnnual_Inflows30$OakleyInflow)+1000)),
                   label = 'Year 30', values = SeperateAnnual_Inflows30$OakleyInflow)
                            )  )%>%
  layout(yaxis = list(title ='Weber at Oakley - Annual Average Inflows'),
         xaxis=list(title='Traces'))


##################################################################################
#Calculation from monthly Inflows to Average annual Inflows by water year##
##################################################################################
Annual_Inflow <-Data %>% 
  group_by(WaterYear,Trace_Notation) %>% 
  summarise_all(funs(sum(Shortage)))

Avg_Annual_Inflows <- Annual_Inflow %>%
  group_by(Trace_Notation) %>%
  summarise_all(funs(mean(Shortage)))

Avg_Annual_Inflows<-data.frame(Avg_Annual_Inflows)
colnames(Avg_Annual_Shortage)<-"Annual Avg Inflows"

Avg_Annual_Inflows$Trace_Notation <- Trace_Notation
colnames(Avg_Annual_Inflows)[2]<-"Trace_Notation"


##################################################################################
#Repeat Calculation from monthly shortage to total annual shortage by water year##
##################################################################################
Annual_Shortage <-Data %>% 
  group_by(WaterYear,Trace_Notation) %>% 
  summarise_all(funs(sum(Shortage)))

Avg_Annual_Shortage <- Annual_Shortage %>%
  group_by(Trace_Notation) %>%
  summarise_all(funs(mean(Shortage)))

Avg_Annual_Shortage<-data.frame(Avg_Annual_Shortage$Shortage)
colnames(Avg_Annual_Shortage)<-"Annual Avg Shortage"

Avg_Annual_Shortage$Trace_Notation <- Trace_Notation
colnames(Avg_Annual_Shortage)[2]<-"Trace_Notation"

#########################################################################################################
####### Calculate Annual Shortage by Water Year #######
#########################################################################################################

#From Monthly Shortages to  Annual Shortages
  #Annual_Shortages <-DataDF %>% 
  # group_by(WaterYear,Trace_Notation) %>% 
  #summarise_all(funs(sum(Shortage)))                   #Issues with intergrating into Data dataframe

  #Annual_Shortages<-data.frame(Annual_Shortages)
  #colnames(Avg_Annual_Inflow)<-"Annual Shortages"
  #Annual_Shortages$Trace_Notation <-Trace_Notation

#########################################################################################################
####### Join Inflow and Shortage Data to DataDF###########
#########################################################################################################

      #Data <- full_join(Data,Annual_Inflows,by="Trace_Notation")
      #Data <- full_join(Data,Avg_Annual_Shortage,by ="Trace_Notation")
#View(Data)








##### Everything below this point has issues use 4c and 4e code







# Reorganize by DER. Calculate storage reliability metrics before filtering.

###########################################################################################################
#################### Reliability  Metric for Storage ########################
###########################################################################################################
#  -- Metrics based on WBWCD - Drought Contigency Plan Drought Levels --  #
# See Table 3-2 : Hot/Dry Projected Drought for Drought Levels
# Moderate Total Basin Storage Drought Level 340K to 380K -- Yellow  ("Less than 380K")
# Severe Total Basin Storage Drought Level 280K to 340K -- Orange    ("Less than 340K")
# Extreme Total Basin Storage Drought Level less than 280K -- Red    ("Less than 280K")

# Define reservoir levels as arrays: Moderate -> Severe -> Extreme
cStoreNames <- c("Moderate", "Severe", "Extreme")
cStorLevels <- c(380000,340000,280000)
cColors <- c("Yellow", "Orange", "Red")
ModerateLevel<- 380000
SevereLevel <- 340000
ExtremeLevel<-280000

#Calculate the number of storage levels
nLevels <- length(cStorLevels)
#Pull out the monthly storage values
    #Storage_Metrics <- data.frame(Data$Tot_Mnthly_Stor)
Storage_Metrics <- data.frame(Data[,c("Month","Tot_Mnthly_Stor")])
#Create more duplicate columns
Storage_Metrics <- cbind(Storage_Metrics, replicate(nLevels-1,Storage_Metrics$Tot_Mnthly_Stor))
#Rename the columns
colnames(Storage_Metrics)[2:(nLevels+1)] <- cStoreNames
#Record the last data column
cLastDataCol <- ncol(Data)

#Loop through columns. In each column convert the storage values to a binary: 1 if greater or equal to target. 0 if below
for (i in 1:nLevels) {
  #Is the storage criteria met?
  Storage_Metrics[,1+i] <- ifelse(Storage_Metrics[,1+i] > cStorLevels[i],1,0) #1 Greater than or equal
  #Storage_Metrics[,1+i] <- ifelse(Storage_Metrics[,1+i] < cStorLevels[i],1,0)   #1 Less than or equal
  
  #Save the result back to the Data datafrom
  Data[,cLastDataCol + i] <- Storage_Metrics[,1+i]
  #Rename the column
  colnames(Data)[cLastDataCol +i] <- cStoreNames[i]
}

cRelColNames <- paste0("Rel", cStoreNames)

#Calculate the average (fraction) for each combination of traces for each column. This represents
#the reliability
dfStorageReliability <-Data[,c("Trace_Notation","Month",cStoreNames)] %>% 
  filter(Month == 6) %>%  #Filter on the June month because that is when we care about storage at criteria
  group_by(Trace_Notation) %>%
  summarise_all(funs(mean))

#Multiply by 100 to get a percent
#dfStorageReliability[,cStoreNames] <- dfStorageReliability[,cStoreNames]*100
dfStorageReliability[,cStoreNames] <- 100-(dfStorageReliability[,cStoreNames]*100)  #Reliability -- How often is metric in below storage specified value

# Rename columns
colnames(dfStorageReliability)[3:5] <- c("Mod Reliability", "Sev Reliability","Ext Reliability")

##### Join the Reservoir storage reliability back with the big data set
AllData<-right_join(Data,dfStorageReliability,by='Trace_Notation')

##### Join Demand Selections Notations
#View(DemandSelections)
  #colnames(DemandSelections)[1]<-"Demand"

#Round up Demand Data
  #DemandSelections[,1]<-round(DemandSelections[,1])
  #AllData<-full_join(AllData,DemandSelections,by="Demand")


##################################################################################################
###PLOTS###
##################################################################################################
library(plotly)
#############################################------------------Plotly--------------------######################################################################  
#Filter Settings Dataframe
##################### Filter Data to plot  ###############

Data_NoSed <- filter(AllData,Sedimentation==0)
Data_10Perc <- filter(AllData,Sedimentation==10)
Data_30Perc <- filter(AllData,Sedimentation==30)

#Select Data frame to do Calculation on. 
PlotData<- Data_NoSed
PlotData10 <- Data_10Perc
PlotData30 <- Data_30Perc

#No Sedimentation
#########Individual PLOTS############
x<-PlotData$Demand
y<-PlotData$Inflow

TorF <- FALSE

# Moderate Demand Level
 z=PlotData$`Mod Reliability`
 
 p1 <- plot_ly(
   x = x,
   y = y,
   z = z , type = "contour",contours = list(showlabels = TRUE),showscale = TorF, colors = c("white","yellow"))%>%
   colorbar(title = "Percent of\n Years below \n Storage Level")%>%
   layout(title = "June 1st Storage Levels Reliability
          Moderate Storage Level (380,000 Acre-Feet)",
          xaxis = list(title ="Demand (Acre-Feet/Year)", showticklabels = FALSE),
          yaxis = list(title = "Inflows (Acre-Feet/Year)") # , 
          #annotations = list(text = "Moderate Storage
           #                  Level (380,000 Acre-Feet)",
            #                 x = 475000,
             #                y = 950000,
              #               yref = "y",
               #              xref = "x",
                #             xanchor = "middle",
                 #            yanchor = "top",
                  #           showarrow = FALSE,
                   #          font = list(size = 15))
          )
 p1
 
 #plotly_IMAGE(p, format = "png", out_file = "Moderate Storage Reliability Plot.png")
 
 #Severe Demand Level
 z=PlotData$`Sev Reliability`
 
 p2 <- plot_ly(
   x = x,
   y = y,
   z = z, type = "contour",contours = list(showlabels = TRUE),showscale = TorF, colors = c("white","orange"))%>%
   colorbar(title = "Percent of\n Years below \n Storage Level")%>%
   layout(title = "June 1st Storage Levels Reliability
          Severe Storage Level (340,000 Acre-Feet)",
          xaxis = list(title ="Demand (Acre-Feet/Year)"),
          yaxis = list(title = "Inflows (Acre-Feet/Year)") # ,
      #    annotations = list(text = "Severe Storage
              #               Level (340,000 Acre-Feet)",
               #              x = 475000,
                #             y = 950000,
                 #            yref = "y",
                  #           xref = "x",
                   #          xanchor = "middle",
                    #         yanchor = "top",
                    #         showarrow = FALSE,
                     #        font = list(size = 15))
)
 p2

 #plotly_IMAGE(p, format = "png", out_file = "Severe Storage Reliability Plot.png")
 
#Extreme Demand Level
 z=PlotData$`Ext Reliability`
 
 p3 <- plot_ly(
   x = x,
   y = y,
   z = z, type = "contour",contours = list(showlabels = TRUE),showscale = TorF,colors = c("white","red"))%>%
   colorbar(title = "Percent of\n Years below \n Storage Level")%>%
   layout(title = "June 1st Storage Levels Reliability
          Extreme Storage Level (280,000 Acre-Feet)",
          xaxis = list(title ="Demand (Acre-Feet/Year)"),
          yaxis = list(title = "Inflows (Acre-Feet/Year)") # ,
          #annotations = list(text = "Extreme Storage
           #                  Level (280,000 Acre-Feet)",
            #                 x = 475000,
             #               y = 950000,
              #               yref = "y",
               #              xref = "x",
                #             xanchor = "middle",
                 #            yanchor = "top",
                  #           showarrow = FALSE,
                   #          font = list(size = 15))
        )
 p3
 #plotly_IMAGE(p, format = "png", out_file = "Extreme Storage Reliability Plot.png")
 
 
 #### Overplot values in 1X1 plot#####
      ### Add Demand Selections to PlotData2
 
 PlotData2<-PlotData
 
 #View(PlotData2)
 
 t <- list(
   family = "sans serif",
   size = 8,
   color = toRGB("grey50"))
 
 #ontop_p1<-add_trace(p1,x=x,y=y,type='scatter',mode='text',text=PlotData$Trace_Notation,textfont= t,textposition = 'middle right', showlegend =F)
 ontop_p1<-add_trace(p1,x=x,y=y,type='scatter', showlegend =F)
ontop_p2<-add_trace(p2,x=x,y=y,type='scatter',showlegend =F)
 ontop_p3<-add_trace(p3,x=x,y=y,type='scatter',showlegend =F)
 
  #ontop_p3<-add_trace(p3,x=x,y=y,type='scatter',showlegend =F)%>%
  # layout(xaxis =list(ticktext=list()))
 
 
 #View
 ontop_p1
 ontop_p2
 ontop_p3
 
 
 
## 1X3 Plot Showing all 0% Sedimentation in 1 row
 s1 <- subplot(p1,p2,p3,nrows = 1, shareY = TRUE)
 #s1
 
 ontop_s2 <- subplot(ontop_p1,ontop_p2,ontop_p3,nrows = 1, shareY = TRUE)
 ontop_s2
 
 #10% Sedimentation
 #########Individual PLOTS############
 x<-PlotData10$Demand
 y<-PlotData10$`Annual Avg Inflow`
 
 # Moderate Demand Level
 z=PlotData10$`Mod Reliability`
 
 p1 <- plot_ly(
   x = x,
   y = y,
   z = z , type = "contour",contours = list(showlabels = TRUE),showscale = TorF,colors = c("white","yellow"))%>%
   colorbar(title = "Percent of\n Years below \n Storage Level")%>%
   layout(title = "June 1st Storage Levels Reliability
          Moderate Storage Level (380,000 Acre-Feet)",
          xaxis = list(title ="Demand (Acre-Feet/Year)"),
          yaxis = list(title = "Inflows (Acre-Feet/Year)"))
 p1
 
 #plotly_IMAGE(p, format = "png", out_file = "Moderate Storage Reliability Plot.png")
 
 #Severe Demand Level
 z=PlotData10$`Sev Reliability`
 
 p2 <- plot_ly(
   x = x,
   y = y,
   z = z, type = "contour",contours = list(showlabels = TRUE),showscale = TorF,colors = c("white","orange"))%>%
   colorbar(title = "Percent of\n Years below \n Storage Level")%>%
   layout(title = "June 1st Storage Levels Reliability
          Severe Storage Level (340,000 Acre-Feet)",
          xaxis = list(title ="Demand (Acre-Feet/Year)"),
          yaxis = list(title = "Inflows (Acre-Feet/Year)"))
 p2
 
 #plotly_IMAGE(p, format = "png", out_file = "Severe Storage Reliability Plot.png")
 
 #Extreme Demand Level
 z=PlotData10$`Ext Reliability`
 
 p3 <- plot_ly(
   x = x,
   y = y,
   z = z, type = "contour",contours = list(showlabels = TRUE),showscale = TorF,colors = c("white","red"))%>%
   colorbar(title = "Percent of\n Years below \n Storage Level")%>%
   layout(title = "June 1st Storage Levels Reliability
          Extreme Storage Level (280,000 Acre-Feet)",
          xaxis = list(title ="Demand (Acre-Feet/Year)"),
          yaxis = list(title = "Inflows (Acre-Feet/Year)"))
 p3
 
 
 #### Overplot values in 1X1 plot#####
 ontop_p1<-add_trace(p1,x=x,y=y,type='scatter',showlegend =F)
 ontop_p2<-add_trace(p2,x=x,y=y,type='scatter',showlegend =F)
 ontop_p3<-add_trace(p3,x=x,y=y,type='scatter',showlegend =F)
 
 #View PLOTS
 ontop_p1
 ontop_p2
 ontop_p3

 ontop_s2 <- subplot(ontop_p1,ontop_p2,ontop_p3,nrows = 1, shareY = TRUE)
 ontop_s2
 
  ## 1X3 Plot Showing all 0% Sedimentation in 1 row 
  s2 <- subplot(p1,p2,p3,nrows = 1, shareY = TRUE)
 #s2
 
 #30% Sedimentation
 #########Individual PLOTS############
 x<-PlotData30$Demand
 y<-PlotData30$`Annual Avg Inflow`
 
 # Moderate Demand Level
 z=PlotData30$`Mod Reliability`
 
 p1 <- plot_ly(
   x = x,
   y = y,
   z = z , type = "contour",contours = list(showlabels = TRUE),showscale = TorF,colors = c("white","yellow"))%>%
   colorbar(title = "Percent of\n Years below \n Storage Level")%>%
   layout(title = "June 1st Storage Levels Reliability
          Moderate Storage Level (380,000 Acre-Feet)",
          xaxis = list(title ="Demand (Acre-Feet/Year)"),
          yaxis = list(title = "Inflows (Acre-Feet/Year)"))
 p1
 
 #plotly_IMAGE(p, format = "png", out_file = "Moderate Storage Reliability Plot.png")
 
 #Severe Demand Level
 z=PlotData30$`Sev Reliability`
 
 p2 <- plot_ly(
   x = x,
   y = y,
   z = z, type = "contour",contours = list(showlabels = TRUE),showscale = TorF,colors = c("white","orange"))%>%
   colorbar(title = "Percent of\n Years below \n Storage Level")%>%
   layout(title = "June 1st Storage Levels Reliability
          Severe Storage Level (340,000 Acre-Feet)",
          xaxis = list(title ="Demand (Acre-Feet/Year)"),
          yaxis = list(title = "Inflows (Acre-Feet/Year)"))
 
 p2
 
 #plotly_IMAGE(p, format = "png", out_file = "Severe Storage Reliability Plot.png")
 
 #Extreme Demand Level
 z=PlotData30$`Ext Reliability`
 
 p3 <- plot_ly(
   x = x,
   y = y,
   z = z, type = "contour",contours = list(showlabels = TRUE),showscale = TorF,colors = c("white","red"))%>%
   colorbar(title = "Percent of\n Years below \n Storage Level")%>%
   layout(title = "June 1st Storage Levels Reliability
          Extreme Storage Level (280,000 Acre-Feet)",
          xaxis = list(title ="Demand (Acre-Feet/Year)"),
          yaxis = list(title = "Inflows (Acre-Feet/Year)"))
 p3

 
 #### Overplot values in 1X1 plot#####
 ontop_p1<-add_trace(p1,x=x,y=y,type='scatter',showlegend =F)
 ontop_p2<-add_trace(p2,x=x,y=y,type='scatter',showlegend =F)
 ontop_p3<-add_trace(p3,x=x,y=y,type='scatter',showlegend =F)
 
 #View plots
 ontop_p1
 ontop_p2
 ontop_p3
 
 ## 1X3 Plot Showing all 0% Sedimentation in 1 row
 ontop_s3 <- subplot(ontop_p1,ontop_p2,ontop_p3,nrows = 1, shareY = TRUE)
 ontop_s3
  
  #plotly_IMAGE(p, format = "png", out_file = "Extreme Storage Reliability Plot.png")
 
 s3 <- subplot(p1,p2,p3,nrows = 1, shareY = TRUE)
  #s3

  ##############################################
#### Create a 3x3 Matrix Plot -- Subplots  ######
 ##############################################
 # y2 <- list(
  #  tickfont = list(color = "Black"),
  # overlaying = "y",
  #  side = "right",
  #  title = "Inflow Scenarios"
  #)
  
p3x3 <- subplot(s1,s2,s3,nrows = 3, shareX = TRUE)%>%
    layout(title = "June 1st Storage Levels -- Reliability", showlegend = FALSE)
 #,
          #yaxis2 = y2,
  #        yaxis = list(title="0% Reservoir Sed"),
   #       yaxis2 = list(title="Demand (Acre-Ft/Year)
    #                    10% Reservoir Sed"),
     #     yaxis3 = list(title="30% Reservoir Sed"),
      #    xaxis2 = list(title= "Inflow (Acre-Ft/Year)")  #,
          #yaxis2 = list(title= "Demand (Acre-Ft/Year)",side="right")
       #   )
 p3x3

 
 
#### Overplot June 1st values #####
 
 x<-PlotData30$Demand
 xx<-PlotData30$Demand
 y<-PlotData30$`Annual Avg Inflow`
 yy<-PlotData30$`Annual Avg Inflow`
 z=PlotData30$`Mod Reliability`
 
p1 <- plot_ly(
   x = x,
   y = y,
   z = z , type = "contour",contours = list(showlabels = TRUE),showscale = TorF,colors = c("white","yellow"))%>%
   colorbar(title = "Percent of\n Years below \n Storage Level")%>%
   layout(title = "June 1st Storage Levels Reliability
          Moderate Storage Level (380,000 Acre-Feet)",
          xaxis = list(title ="Demand (Acre-Feet/Year)"),
          yaxis = list(title = "Inflows (Acre-Feet/Year)")%>%
  add_trace(x=xx,y =yy,type= 'scatter',name ='Inflows',mode = 'markers')
          )
 p1
 
 
 #### Try two...
 
 s <- subplot(
 plot_ly(PlotData30, x = x, y = y,name = 'J1', type = 'scatter', mode = 'markers'),
 plot_ly( x = x, y = y,  z = z , type = "contour",contours = list(showlabels = TRUE),showscale = TorF,colors = c("white","yellow"))%>%
   colorbar(title = "Percent of\n Years below \n Storage Level")%>%
   layout(title = "June 1st Storage Levels Reliability
          Moderate Storage Level (380,000 Acre-Feet)",
          xaxis = list(title ="Demand (Acre-Feet/Year)"),
          yaxis = list(title = "Inflows (Acre-Feet/Year)")))
s

p <- layout(s, title ="June 1st Storage Levels Reliability
          Moderate Storage Level (380,000 Acre-Feet)", showlegend = TRUE)
p


############ Storage Contours based on Moderate, Severe and Extreme Storage Drought Levels  #############################
#Storage
#z=PlotData$Tot_Mnthly_Stor

#p <- plot_ly(
# x = PlotData$Demand,
 #y = PlotData$Inflow,
 #z =z , type = "contour",
  #colors = c("red","orange","yellow","white"),
  ##contours = list(coloring = 'heatmap'),
  #autocontour = F,contours = list(
#start = 280000,
#end = 380000,
#size = 50000
#))%>%
#layout(title = "Storage by Color",
 #        xaxis = list(title ="Demand"),
  #       yaxis = list(title = "Inflows"))
#p

#### DER Plotly Code to double loop to automate the generation of the matrix plot of contours ####
 
## Rows = Sedimintation levels (0, 10, 30) 
## Columns  = Reservoir Storage Targets (Moderate, Severe, Extreme)
##
## Annotations:
 #
 #    - First column has Sedimentation level, y-axis title, and y-axis ticks
 #    - First row has column header (Storage criteria)
 #    - Final row has x-axis title and ticks

# Define the dataframes to populate cell values
 #Storage Targets:
 dfStorageTargets <- data.frame(Name = c("Moderate","Severe","Extreme"),
                                Color = c("Yellow","Orange","Red"),
                                Volume = c(380000,340000,280000),
                                ColumnNum = c(17:19))  #Variable/column number of reliability results in big data frame
 
 cSedValues <- unique(AllData$Sedimentation)
 
 nTargets <- nrow(dfStorageTargets)
 nSeds <- length(cSedValues)
 
 AxisTitles <- c("Demand (Acre-Feet/Year)","Inflows (Acre-Feet/Year)")
 library("scales")
 
 # Define the Y-axis titles as a matrix
 mYAxisTitles <- matrix(data="",nrow=nTargets,ncol=nSeds) 
 #Loop over the rows
 for (iRow in (1:nSeds)) {
    mYAxisTitles[iRow,1] <- paste("SEDIMENT", percent(cSedValues[iRow]/100),"\n",AxisTitles[2])
 }
 
 #Define the X-axis titles as a matrix
 mXAxisTitles <- matrix(data="", nrow=nTargets, ncol=nSeds) 
 mXAxisTitles[nSeds,1:nTargets] <- AxisTitles[1]
 
 #Define whether to show the X- and Y- axis Ticks
 mShowXTicks <- matrix(data=FALSE, nrow=nTargets, ncol=nSeds)
 mShowYTicks <- mShowXTicks
 mShowXTicks[nSeds,1:nTargets] <- TRUE
 mShowYTicks[1:nSeds,1] <- TRUE
 
 # Define the Plot titles as a matrix
 mTitles <- matrix(data="", nrow=nTargets, ncol = nSeds)

#Loop over the columns
 for (iCol in (1:nTargets)) {
   mTitles[1,iCol] <- paste(dfStorageTargets$Name[iCol],"\n(",formatC(dfStorageTargets$Volume[iCol],format="f", big.mark=",", digits=0)," acre-feet)", sep="")
 }

 #Matrix of lists to store plot information
 
 plotList <- function(nplots) {
   lapply(seq_len(nplots), function(x) plot_ly())
 }
 
 #Filter AllData down to a single row per inflow/demand/sedimentation combination
 dfScenResults <- AllData %>% filter(Month.x == 1, WaterYear == 1)
 
 for (iRow in (1:1)) {
   for (iCol in (1:nTargets)) {
     
     #iRow <- 1
     #iCol <- 1
     
     #Filter the sedimentation data
     dfPlotData <- dfScenResults %>% filter(Sedimentation == cSedValues[iRow])
     
     lCurrPlot <- plot_ly(
       x = dfPlotData$Demand,
       y = dfPlotData$`Annual Avg Inflow`,
       z = dfPlotData[,dfStorageTargets$ColumnNum[iCol]],
       type = "contour",contours = list(showlabels = TRUE),showscale = FALSE, 
       colors = c(as.character(dfStorageTargets$Color[iCol]),"white")) %>%
       #colorbar(title = "Percent of\n Simulated Years")%>%
       layout(title = "",
              #xaxis = list(title =mXAxisTitles[iRow,iCol], showticklabels = mShowXTicks[iRow,iCol]),
              #yaxis = list(title = mYAxisTitles[iRow,iCol],showticklabels = mShowYTicks[iRow,iCol]),
              xaxis = list(title =AxisTitles[1], showticklabels = TRUE),
              yaxis = list(title = AxisTitles[2],showticklabels = TRUE),
              annotations = list(text = mTitles[iRow,iCol],
                                 x = 475000,
                                 y = 950000,
                                 yref = "y",
                                 xref = "x",
                                 xanchor = "middle",
                                 yanchor = "top",
                                 showarrow = FALSE,
                                 font = list(size = 15)))
              
         
     print(lCurrPlot)
     
     #Generate a subplot
     if (iCol == 1) {
       lPlot1 <- lCurrPlot
     } else if (iCol == 2) {
       lPlot2 <- lCurrPlot
     } else lPlot3 <- lCurrPlot
      
   }
   
   lPlotRow <- subplot(lPlot1, lPlot2, lPlot3, nrows = 1, shareY = TRUE, shareX = TRUE)
   
   if (iRow == 1) {
      lRow1 <- lPlotRow
   } else if (iRow == 2) {
      lRow2 <- lPlotRow
   } else lRow3 <- lPlotRow
  
 }
 
subplot(lRow1,lRow2,lRow3,nrows = 3, shareX = TRUE, shareY = TRUE)
 

############ End of June 1 code##########
setwd(startWD)