###Total Storage Compilation#--------------------------------------------------------------------------------#
#Store the current code directory so we can later return to it (0 - Code)
### Load the package or install if not present
if (!require("RColorBrewer")) {
  install.packages("RColorBrewer")
  library(RColorBrewer)
}
library(readr)
#install.packages("reshape")
library(reshape) #For Melt
library(lubridate) #For month
library(plotly) # For Plots
library(data.table)
library(dplyr)


### Clear any existing data or functions.
rm(list=ls())
library("dplyr", lib.loc="~/R/win-library/3.5")

setwd("../1 - Scenario Processing/Annual Service Area Demand Scenarios/Output")
setwd("~/GitHub/WeberBasinVulnerability/WeberBasinVulnerability/1 - Scenario Processing/Annual Service Area Demand Scenarios/Output")


### Willard Evaporation #####

##### Total Storage #####
i=1
for(TTTNum in 1:TraceNumber){
  for(TTNum in 1:TraceNumber1){
    for(TNum in 1:TraceNumber2){
      TraceDirectory <- paste0(",Trace",TNum)
      TraceDirectory <-paste0 (TraceDirectory,",RiverWare MRM,Weber Basin RiverWare Model,RiverWare Policy/.csv")
      TraceNum1<- paste0(",Trace",TTNum)
      TraceDirectory <- paste0(TraceNum1,TraceDirectory)
      TraceNum2 <- paste0("Trace",TTTNum)
      TraceDirectory <- paste0(TraceNum2,TraceDirectory)
      
      Location <- TraceDirectory
      Temp_Storage <- read.csv(Location)
      Tot_Mnthly_Stor[,i] <- Temp_Storage[,5]
      
      colnames(Tot_Mnthly_Stor)[i] <-  TraceDirectory
      i=i+1
    }
  }
}
Tot_Mnthly_Stor <- data.frame(Tot_Mnthly_Stor)













####-----------------------------Trace Notation--------------------------------------------------
# Build names of folders output by RiverSmart
TraceNumber <- 6
TraceNumber1 <-3
TraceNumber2 <-6
Tot_TraceNum <- TraceNumber*TraceNumber1*TraceNumber2

Trace_Notation <-c(1:Tot_TraceNum)
i=1
for(TTTNum in 1:TraceNumber){
  for(TTNum in 1:TraceNumber1){
    for(TNum in 1:TraceNumber2){
      TraceDirectory <- paste0(",Trace",TNum)
      TraceNum1<- paste0(",Trace",TTNum)
      TraceDirectory <- paste0(TraceNum1,TraceDirectory)
      TraceNum2 <- paste0("Trace",TTTNum)
      TraceDirectory <- paste0(TraceNum2,TraceDirectory)
      
      Trace_Notation[i] <-  TraceDirectory
      i=i+1
    }
  }
}

Trace_Notation_Data<- rep(Trace_Notation,359)

#View(Trace_Notation_Data)

##################################  - 1 - Input data ########################################################

######## - A -   Compiling Annual Demands  ########

setwd("../1 - Scenario Processing/Annual Service Area Demand Scenarios/Output")
setwd("~/GitHub/WeberBasinVulnerability/WeberBasinVulnerability/1 - Scenario Processing/Annual Service Area Demand Scenarios/Output")

Tot_Annual_Demand <- read.csv("SumMIandAG.csv")
Tot_Demand <- data.frame(c(1:108))

i=1
j=1
while (i<=6) {
  Tot_Demand[j:(j+17),] <- rep(Tot_Annual_Demand[i,2],(18))  
  i=i+1
  j=j+18
}

#View(Tot_Demand)
colnames(Tot_Demand) <- "Demand"
rownames(Tot_Demand) <- Trace_Notation

#Tot_Demand <- data.frame(Tot_Demand)

Tot_Mnthly_Demand<-data.frame(rep(Tot_Demand$Demand,359))
colnames(Tot_Mnthly_Demand) <- "Demand"
#View(Tot_Monthly_Inflow)              

######### - B -  Monthly Inflows Data  ##########

# Switch into local directory
setwd("~/GitHub/WeberBasinVulnerability/WeberBasinVulnerability/2 - RiverWare Modeling/With Evaporation Modeling/Scenario")
setwd(startWD)
setwd("../2 - RiverWare Modeling/With Evaporation Modeling/Scenario")

#Input Monthly data from RiverSmart Analysis
Tot_Mnthly_Inflow <-read.csv("Trace1,Trace1,Trace1,RiverWare MRM,Weber Basin RiverWare Model,RiverWare Policy/Total Inflows.csv")

i=1
for(TTTNum in 1:TraceNumber){
  for(TTNum in 1:TraceNumber1){
    for(TNum in 1:TraceNumber2){
      TraceDirectory <- paste0(",Trace",TNum)
      TraceDirectory <-paste0 (TraceDirectory,",RiverWare MRM,Weber Basin RiverWare Model,RiverWare Policy/Total Inflows.csv")
      TraceNum1<- paste0(",Trace",TTNum)
      TraceDirectory <- paste0(TraceNum1,TraceDirectory)
      TraceNum2 <- paste0("Trace",TTTNum)
      TraceDirectory <- paste0(TraceNum2,TraceDirectory)
      
      Location <- TraceDirectory
      Temp_Storage <- read.csv(Location)
      Tot_Mnthly_Inflow[,i] <- Temp_Storage[,5]
      
      colnames(Tot_Mnthly_Inflow)[i] <-  TraceDirectory
      i=i+1
    }
  }
}

Tot_Mnthly_Inflow <- data.frame(Tot_Mnthly_Inflow)
#View(Tot_Mnthly_Inflow)

Months <- rep(c(1:12),31)
Months<- Months[(11:369)]
Tot_Mnthly_Inflow$Months <- Months

#Create Years
Years <- c(0:372)
i=1
j=1
while (j<=31) {
  Years[(i:(i+11))] <- rep((j-1),12)
  i=i+12
  j=j+1
}
Years<- Years[(11:369)]

#Add months and Years column
#Tot_Mnthly_Inflow$Months <-Months
Tot_Mnthly_Inflow$Years <- Years

#Add a Water year - The water year is designated by the calendar year in which it ends, so the 2010 water year (USGS) started on October 1, 2009 and ended on September 30, 2010
Tot_Mnthly_Inflow$WaterYear <- ifelse(Tot_Mnthly_Inflow$Months>= 10,Tot_Mnthly_Inflow$Years + 1, Tot_Mnthly_Inflow$Years)
WaterYear  <-                  ifelse(Tot_Mnthly_Inflow$Months>= 10,Tot_Mnthly_Inflow$Years + 1, Tot_Mnthly_Inflow$Years)

#Transpose Data
Tot_Mnthly_Inflow_Transposed <- t(Tot_Mnthly_Inflow)
Tot_Mnthly_Inflow_Transposed <- data.frame(Tot_Mnthly_Inflow_Transposed)
#View(Tot_Mnthly_Inflow_Transposed)
#Stack Columns
Tot_Mnthly_Inflow_Stacked <- stack(Tot_Mnthly_Inflow_Transposed[1:108,1:359])
Tot_Mnthly_Inflow <- Tot_Mnthly_Inflow_Stacked$values


######## - C -   Compiling Total Evaporation  ########

##Total Sedimentation Changes on Reservoir
#Move back to code directory
setwd(startWD)
#Move into the local input directory
setwd("../3 - Post Processing")

setwd("~/GitHub/WeberBasinVulnerability/WeberBasinVulnerability/3 - Post Processing")


Tot_Sed <- read.csv("Evaporation.csv")
Tot_Sed <- Tot_Sed[,2]
Tot_Mnthly_Sed <- rep(Tot_Sed,359)


#### Time Columns: Mnths, Years and Water Years #####
Mnths<-c(1:38772)
i=1
j=1
while (i<=359) {
  Mnths[j:(i*108)]<-Months[i]    
  i=i+1
  j=j+108
}
#View(Mnths)

Yrs<-c(1:38772)
i=1
j=1
while (i<=359) {
  Yrs[j:(i*108)]<-Years[i]    
  i=i+1
  j=j+108
}
#View(Yrs)

Wtr_Yrs<-c(1:38772)
i=1
j=1
while (i<=359) {
  Wtr_Yrs[j:(i*108)]<-WaterYear[i]    
  i=i+1
  j=j+108
}

##################   Compile Mnthly Input data    ##################################
#Create Data Frame
Inputs<- data.frame(Tot_Mnthly_Demand)
Inputs$Inflow <- Tot_Mnthly_Inflow
Inputs$Sedimentation <- Tot_Mnthly_Sed
Inputs$Trace_Notation <- Trace_Notation
Inputs$Month<-Mnths
Inputs$Years<-Yrs
Inputs$WaterYear<-Wtr_Yrs
#Number
Inputs$Number<-c(1:38772)
Inputs <- data.frame(Inputs)

##################################  - 2 - Output data ########################################################
#Set Local Directory
setwd(startWD)
setwd("../2 - RiverWare Modeling/With Evaporation Modeling/Scenario")

setwd("~/GitHub/WeberBasinVulnerability/WeberBasinVulnerability/2 - RiverWare Modeling/With Evaporation Modeling/Scenario")

Tot_Mnthly_Stor <- read.csv("Trace1,Trace1,Trace1,RiverWare MRM,Weber Basin RiverWare Model,RiverWare Policy/Total Storage_NO EVAP.csv")
Tot_Mnthly_Short <-read.csv("Trace1,Trace1,Trace1,RiverWare MRM,Weber Basin RiverWare Model,RiverWare Policy/Total Shortages.csv")

#Create TraceFolder Naming lookup for Values with No Evap.
#Move into the local input directory
#setwd("../2 - RiverWare Modeling/With Evaporation Modeling/Scenario")
# Switch into local directory
#setwd("~/GitHub/WeberBasinVulnerability/WeberBasinVulnerability/2 - RiverWare Modeling/With Evaporation Modeling/Scenario")

##### Total Storage #####
i=1
for(TTTNum in 1:TraceNumber){
  for(TTNum in 1:TraceNumber1){
    for(TNum in 1:TraceNumber2){
      TraceDirectory <- paste0(",Trace",TNum)
      TraceDirectory <-paste0 (TraceDirectory,",RiverWare MRM,Weber Basin RiverWare Model,RiverWare Policy/Total Storage_NO EVAP.csv")
      TraceNum1<- paste0(",Trace",TTNum)
      TraceDirectory <- paste0(TraceNum1,TraceDirectory)
      TraceNum2 <- paste0("Trace",TTTNum)
      TraceDirectory <- paste0(TraceNum2,TraceDirectory)
      
      Location <- TraceDirectory
      Temp_Storage <- read.csv(Location)
      Tot_Mnthly_Stor[,i] <- Temp_Storage[,5]
      
      colnames(Tot_Mnthly_Stor)[i] <-  TraceDirectory
      i=i+1
    }
  }
}
Tot_Mnthly_Stor <- data.frame(Tot_Mnthly_Stor)

#Transpose Data
Tot_Mnthly_Stor_Transposed <- t(Tot_Mnthly_Stor)
Tot_Mnthly_Stor_Transposed <- data.frame(Tot_Mnthly_Stor_Transposed)
#View(Tot_Mnthly_Inflow_Transposed)
#Stack Columns
Tot_Mnthly_Stor_Stacked <- stack(Tot_Mnthly_Stor_Transposed[1:108,1:359])
Tot_Mnthly_Stor <- Tot_Mnthly_Stor_Stacked$values
Tot_Mnthly_Stor <- data.frame(Tot_Mnthly_Stor)

##### Total Shortages #####
i=1
for(TTTNum in 1:TraceNumber){
  for(TTNum in 1:TraceNumber1){
    for(TNum in 1:TraceNumber2){
      TraceDirectory <- paste0(",Trace",TNum)
      TraceDirectory <-paste0 (TraceDirectory,",RiverWare MRM,Weber Basin RiverWare Model,RiverWare Policy/Total Shortages.csv")
      TraceNum1<- paste0(",Trace",TTNum)
      TraceDirectory <- paste0(TraceNum1,TraceDirectory)
      TraceNum2 <- paste0("Trace",TTTNum)
      TraceDirectory <- paste0(TraceNum2,TraceDirectory)
      Location <- TraceDirectory
      Temp_Storage <- read.csv(Location)
      Tot_Mnthly_Short[,i] <- Temp_Storage[,5]
      colnames(Tot_Mnthly_Short)[i] <-  TraceDirectory
      i=i+1
    }
  }
}
Tot_Mnthly_Short <- data.frame(Tot_Mnthly_Short)

#Transpose Data
Tot_Mnthly_Short_Transposed <- t(Tot_Mnthly_Short)
Tot_Mnthly_Short_Transposed <- data.frame(Tot_Mnthly_Short_Transposed)
#View(Tot_Mnthly_Inflow_Transposed)
#Stack Columns
Tot_Mnthly_Short_Stacked <- stack(Tot_Mnthly_Short_Transposed[1:108,1:359])
Tot_Mnthly_Short <- Tot_Mnthly_Short_Stacked$values
#Tot_Mnthly_Short <- data.frame(Tot_Mnthly_Short)


########################   Compile Output data   ###############################
Outputs <- Tot_Mnthly_Stor
Outputs$Shortage <- Tot_Mnthly_Short

# Add Trace Notation
#Outputs$Trace_Notation <-Trace_Notation
#Number
Outputs$Number<-c(1:38772)

Outputs<-data.frame(Outputs)

#########################  Merge  ---- Data Dataframe########################
Data <- merge(Inputs,Outputs,by="Number")  
#Data_Monthly <- Data
